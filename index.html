<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ACC – Centre libre (diamètre) · Echome Énergies</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --ink:#1c1c1c; --line:#e6eaea; --ok:#0f766e; --bad:#b91c1c; --brand:#37C3AF;
      --hit:44px;
    }
    html,body{height:100%}
    body{margin:0;font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;color:var(--ink);background:#fff;padding-bottom:env(safe-area-inset-bottom)}

    header.slim{display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--line);padding:6px 8px}
    .brand{display:flex;align-items:center;gap:8px}
    .brand svg{height:26px;width:auto;border-radius:6px;box-shadow:0 0 0 1px rgba(0,0,0,.06)}
    .controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:space-between;width:100%}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;min-height:var(--hit)}
    .dot{width:10px;height:10px;border-radius:50%}
    .prod{background:#6D28D9}.cons{background:#2e86de}.poi{background:#E10600}

    .btn{padding:8px 10px;border:1px solid var(--brand);border-radius:12px;background:var(--brand);color:#fff;cursor:pointer;font-weight:700;min-height:var(--hit)}
    .btn.icon{min-width:44px;display:inline-flex;align-items:center;justify-content:center}
    .btn.secondary{background:#fff;color:#0f4f47;border-color:var(--brand)}
    select, input[type="number"], input[type="text"], input[type="file"]{border:1px solid var(--line);border-radius:10px;padding:8px 10px;min-height:var(--hit)}

    #status{margin:6px 8px 0;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff;font-size:14px}
    #status.ok{background:rgba(55,195,175,.08);border-color:rgba(55,195,175,.45);color:#116a60}
    #status.ko{background:#fff5f3;border-color:#f6d2cc}

    #map{min-height:560px;margin:8px;border:1px solid var(--line);border-radius:12px;position:relative}
    .legend-overlay{position:absolute;bottom:10px;left:10px;background:rgba(255,255,255,.92);border:1px solid var(--line);border-radius:10px;padding:6px 8px;display:flex;gap:10px;font-size:12px}

    #drawer{position:fixed;inset:auto 0 0 auto;top:0;height:100vh;width:420px;max-width:92vw;background:#fff;border-left:1px solid var(--line);box-shadow:-8px 0 24px rgba(0,0,0,.08);transform:translateX(100%);transition:.25s ease;z-index:5000;display:flex;flex-direction:column}
    #drawer.open{transform:none}
    #drawer header{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--line);cursor:grab}
    #drawer .content{padding:12px;overflow:auto;max-height:calc(100vh - 52px)}
    fieldset{border:1px solid var(--line);border-radius:10px;margin:10px 0;padding:10px}
    legend{padding:0 6px;color:#475569;font-size:12px}
    textarea{width:100%;min-height:80px;resize:vertical;border:1px solid var(--line);border-radius:10px;padding:10px}
    .small{font-size:12px;color:#64748b}

    @media (max-width: 768px){
      #map{ height: calc(100dvh - 64px); }
      #drawer{inset:auto 0 env(safe-area-inset-bottom) 0;top:auto;width:100%;height:60dvh;transform:translateY(100%);border-left:none;border-top:1px solid var(--line);border-radius:12px 12px 0 0}
      #drawer.open{transform:none}
      #drawer .content{max-height:calc(60dvh - 52px)}
    }
  </style>
</head>
<body>
  <header class="slim">
    <div class="brand">
      <svg viewBox="0 0 120 32"><rect x="0" y="0" width="120" height="32" rx="6" fill="#37C3AF"/><text x="60" y="19" text-anchor="middle" font-size="14" fill="#fff">ECHOME</text></svg>
      <span>Echome Énergies</span>
    </div>
    <div class="controls">
      <label class="chip"><input type="radio" name="ptype" value="consumer" checked> <span class="dot cons"></span>Cons.</label>
      <label class="chip"><input type="radio" name="ptype" value="producer"> <span class="dot prod"></span>Prod.</label>
      <div>
        <select id="limitSel"><option value="2">2 km</option><option value="10" selected>10 km</option><option value="20">20 km</option></select>
        <input id="customKm" type="number" style="display:none;width:80px" placeholder="km">
      </div>
      <button id="gearBtn" class="btn secondary">⚙️</button>
    </div>
  </header>

  <div id="status">Initialisation…</div>
  <div id="map">
    <div class="legend-overlay">
      <div><span class="dot prod"></span> Prod.</div>
      <div><span class="dot cons"></span> Cons.</div>
      <div><span class="dot poi"></span> POI</div>
    </div>
  </div>

  <aside id="drawer">
    <header><h2>Options</h2><button id="drawerClose" class="btn secondary">Fermer</button></header>
    <div class="content">
      <fieldset>
        <legend>Projet</legend>
        <input id="projName" placeholder="Nom du projet">
        <button id="saveLocal" class="btn">Enregistrer</button>
        <button id="exportJson" class="btn">Exporter</button>
        <input id="importJson" type="file" accept="application/json">
      </fieldset>
      <fieldset>
        <legend>Import rapide</legend>
        <textarea id="bulk"></textarea>
        <button id="importBtn" class="btn">Importer</button>
      </fieldset>
      <fieldset>
        <legend>Candidats OSM</legend>
        <button id="loadCandidates" class="btn">Charger candidats</button>
      </fieldset>
      <fieldset>
        <legend>POI Incendie</legend>
        <button id="loadPoiZone" class="btn">Charger POI</button>
      </fieldset>
    </div>
  </aside>

  <script>
  const statusEl=document.getElementById('status');
  const map=L.map('map',{zoomControl:true,scrollWheelZoom:false}).setView([45.3,5.6],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  L.control.zoom({position:'bottomright'}).addTo(map);

  const participants=[]; const colors={producer:'#6D28D9',consumer:'#2e86de'};
  function addParticipant(lat,lng,type,name){const m=L.circleMarker([lat,lng],{radius:7,color:colors[type]}).addTo(map);participants.push({lat,lng,type,name:name||type,marker:m});refreshACC();}
  function refreshACC(){statusEl.innerHTML="Zone ACC actualisée"; if(participants.length){const center=participants[0];annotateLocationAtCenter(center);} }

  async function fetchCommuneAt(lat,lon){try{const r=await fetch(`https://geo.api.gouv.fr/communes?lat=${lat}&lon=${lon}&fields=nom,epci&format=json`);const j=await r.json();return j[0];}catch(e){return null;}}
  async function annotateLocationAtCenter(center){const c=await fetchCommuneAt(center.lat,center.lng);if(!c)return;const div=document.createElement('div');div.className='small';div.textContent=`Commune: ${c.nom} · EPCI: ${c.epci?.nom||'—'}`;statusEl.appendChild(div);}
  </script>
</body>
</html>
