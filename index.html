<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACC ‚Äì Centre libre (diam√®tre) ¬∑ Echome √ânergies</title>

  <!-- Leaflet CSS (+ fallback) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <!-- Theme & PWA -->
  <meta name="theme-color" content="#37C3AF">
  <link rel="icon" href="./icon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="./icon-192.png" sizes="192x192" type="image/png">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <link rel="manifest" href="./manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    :root{--ink:#1c1c1c;--line:#e6eaea;--muted:#f7f8f8;--ok:#0f766e;--bad:#b91c1c;--brand:#37C3AF}
    html,body{height:100%}
    body{margin:0;font-family:'Open Sans',system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:#fff}

    header.slim{display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--line);padding:6px 8px}
    .brand{display:flex;align-items:center;gap:8px}
    .brand img{height:26px;width:26px;border-radius:6px;box-shadow:0 0 0 1px rgba(0,0,0,.06)}
    .brand .name{font-family:'Montserrat',sans-serif;font-weight:700;letter-spacing:.3px}
    .controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:space-between;width:100%}
    .group{display:flex;align-items:center;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .dot{width:10px;height:10px;border-radius:50%}
    .prod{background:#6D28D9}.cons{background:#2e86de}.poi{background:#E10600}
    .btn{padding:6px 8px;border:1px solid var(--brand);border-radius:10px;background:var(--brand);color:#fff;cursor:pointer;font-weight:700}
    .btn.icon{padding:6px 8px;min-width:36px;display:inline-flex;align-items:center;justify-content:center}
    .btn.secondary{background:#fff;color:#0f4f47;border-color:var(--brand)}
    select,input[type="number"],input[type="text"]{border:1px solid var(--line);border-radius:8px;padding:6px 8px}

    #status{margin:6px 8px 0;border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff;font-size:14px}
    #status.ok{background:rgba(55,195,175,.08);border-color:rgba(55,195,175,.45);color:#116a60}
    #status.ko{background:#fff5f3;border-color:#f6d2cc}

    #map{min-height:420px;margin:8px;border:1px solid var(--line);border-radius:12px;position:relative}

    .legend-overlay{position:absolute;bottom:10px;left:10px;background:rgba(255,255,255,.9);border:1px solid var(--line);border-radius:8px;padding:6px 8px;display:flex;gap:10px;align-items:center;font-size:12px}
    .legend-overlay .item{display:flex;align-items:center;gap:6px}

    .leaflet-control.ratio-control{background:rgba(255,255,255,.95);border:1px solid var(--line);border-radius:8px;padding:4px 8px;font-size:12px;z-index:1000}
    .center-free-tip{background:#111827;color:#fff;padding:2px 6px;border-radius:6px;font-size:11px;box-shadow:0 2px 8px rgba(0,0,0,.2)}

    .print-header{display:none}
    .print-legend{display:none}
    @media print{
      @page { size: A4 landscape; margin: 12mm; }
      header.slim, #status{ display:none !important; }
      body{ background:#fff; }
      .print-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
      .print-header .left{display:flex;align-items:center;gap:8px}
      .print-header .brand img{height:26px}
      .print-header .title{font-family:'Montserrat',sans-serif;font-weight:700}
      #map{ height:170mm !important; min-height:170mm !important; margin:0; border:0 }
      .legend-overlay{ display:none; }
      .print-legend{display:grid;grid-template-columns:auto 1fr;gap:4px 8px;margin-top:8px;font-size:12px}
    }
  </style>
</head>
<body>
  <header class="slim">
    <div class="brand" role="img" aria-label="Echome √ânergies">
      <img src="./icon-192.png" alt="">
      <span class="name">Echome √ânergies</span>
    </div>
    <div class="controls">
      <div class="group" role="radiogroup" aria-label="Type de point (ACC)">
        <label class="chip"><input type="radio" name="ptype" value="consumer" checked> <span class="dot cons"></span>Cons.</label>
        <label class="chip"><input type="radio" name="ptype" value="producer"> <span class="dot prod"></span>Prod.</label>
      </div>
      <div class="group" aria-label="Diam√®tre">
        <label class="small">Diam√®tre :</label>
        <select id="limitSel" aria-label="Diam√®tre autoris√©">
          <option value="2">2 km</option>
          <option value="10">10 km</option>
          <option value="20" selected>20 km</option>
          <option value="custom">Perso</option>
        </select>
        <input id="customKm" type="number" min="0" step="0.1" placeholder="km" style="width:90px;display:none" aria-label="Diam√®tre personnalis√©">
      </div>
      <div class="group">
        <button id="locateBtn" class="btn icon" title="Me localiser" aria-label="Me localiser">üìç</button>
        <button id="fitBtn" class="btn icon" title="Ajuster la vue" aria-label="Ajuster la vue">üó∫Ô∏è</button>
        <button id="printBtn" class="btn icon" title="Exporter en PDF" aria-label="Exporter en PDF">üñ®Ô∏è</button>
        <button id="clearBtn" class="btn icon" title="Effacer les participants" aria-label="Effacer les participants">üóëÔ∏è</button>
      </div>
    </div>
  </header>

  <div class="print-header" id="printHeader">
    <div class="left brand">
      <img src="./icon-192.png" alt="">
      <span class="title">ACC ‚Äì Centre libre (diam√®tre)</span>
    </div>
    <div class="right small" id="printMeta"></div>
  </div>

  <div id="status" role="status" aria-live="polite">Initialisation‚Ä¶</div>
  <div id="map" aria-label="Carte interactive">
    <div class="legend-overlay">
      <div class="item"><span class="dot prod"></span>Producteur</div>
      <div class="item"><span class="dot cons"></span>Consommateur</div>
    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
    (function ensureLeaflet(cb){ if(window.L){ cb(); return; }
      var s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js';
      s.crossOrigin='anonymous'; s.referrerPolicy='no-referrer'; s.onload=cb;
      s.onerror=function(){ document.getElementById('status').textContent='Erreur : Leaflet bloqu√©.'; };
      document.head.appendChild(s);
    })(initApp);

    function initApp(){
      const statusEl=document.getElementById('status');
      const mapEl=document.getElementById('map');

      // Utils
      const eps=1e-9,toRad=d=>d*Math.PI/180;
      const esc=s=>String(s||'').replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
      const safeText=s=>String(s??'');
      const tSet=(el,txt,cls='')=>{el.className=cls;el.textContent=txt;};
      const hSet=(el,html,cls='')=>{el.className=cls;el.innerHTML=html;};
      const fmtDate=d=>{const p=n=>String(n).padStart(2,'0');return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;};
      function haversineKm(a,b){const R=6371;const dLat=toRad(b.lat-a.lat),dLon=toRad(b.lng-a.lng);const lat1=toRad(a.lat),lat2=toRad(b.lat);const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(h));}

      // MEC helpers
      function projectLocal(pointsLL){const lat0=pointsLL.reduce((s,p)=>s+p.lat,0)/pointsLL.length;const lon0=pointsLL.reduce((s,p)=>s+p.lng,0)/pointsLL.length;const P=pointsLL.map(p=>({x:(p.lng-lon0)*111.32*Math.cos(lat0*Math.PI/180),y:(p.lat-lat0)*111.32}));return{lat0,lon0,P};}
      function unprojectLocal(lat0,lon0,x,y){return{lat:lat0+y/111.32,lng:lon0+x/(111.32*Math.cos(lat0*Math.PI/180))};}
      function dist2(a,b){const dx=a.x-b.x,dy=a.y-b.y;return dx*dx+dy*dy;}
      function circleBy2(a,b){return{x:(a.x+b.x)/2,y:(a.y+b.y)/2,r:Math.sqrt(dist2(a,b))/2};}
      function circleBy3(a,b,c){const A=b.x-a.x,B=b.y-a.y,C=c.x-a.x,D=c.y-a.y;const E=A*(a.x+b.x)+B*(a.y+b.y);const F=C*(a.x+c.x)+D*(a.y+c.y);const G=2*(A*(c.y-b.y)-B*(c.x-b.x));if(Math.abs(G)<1e-12)return null;const x=(D*E-B*F)/G,y=(A*F-C*E)/G,r=Math.hypot(x-a.x,y-a.y);return{x,y,r};}
      function inCircle(c,p){return Math.hypot(c.x-p.x,c.y-p.y)<=c.r+1e-9;}
      function minimalEnclosingCircle(pointsLL){
        if(pointsLL.length===0) return null;
        if(pointsLL.length===1) return {center:pointsLL[0], r:0};
        const {lat0,lon0,P}=projectLocal(pointsLL);
        let best=null;
        for(let i=0;i<P.length;i++) for(let j=i+1;j<P.length;j++){
          const c=circleBy2(P[i],P[j]);
          if(P.every(p=>inCircle(c,p))) if(!best||c.r<best.r) best=c;
        }
        for(let i=0;i<P.length;i++) for(let j=i+1;j<P.length;j++) for(let k=j+1;k<P.length;k++){
          const c=circleBy3(P[i],P[j],P[k]); if(!c) continue;
          if(P.every(p=>inCircle(c,p))) if(!best||c.r<best.r) best=c;
        }
        if(!best){
          let max=-1,a=-1,b=-1;
          for(let i=0;i<P.length;i++) for(let j=i+1;j<P.length;j++){
            const d=dist2(P[i],P[j]); if(d>max){max=d;a=i;b=j;}
          }
          best=circleBy2(P[a],P[b]);
        }
        const center=unprojectLocal(lat0,lon0,best.x,best.y);
        return {center, r:best.r};
      }

      // Map
      const map=L.map('map',{zoomControl:true}).setView([45.3,5.6],8);
      const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'});
      const carto=L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© Carto, ¬© OpenStreetMap'});
      osm.on('tileerror',()=>{ if(!map.hasLayer(carto)) carto.addTo(map); if(map.hasLayer(osm)) map.removeLayer(osm); tSet(statusEl,'Fond OSM bloqu√© ‚Üí Carto Light.'); });
      osm.addTo(map);
      L.control.scale({imperial:false,metric:true,maxWidth:120}).addTo(map);

      // Ratio 1:n
      const RatioControl=L.Control.extend({
        options:{position:'topright'},
        onAdd:function(map){const div=L.DomUtil.create('div','leaflet-control ratio-control');this._div=div;this._map=map;this._update=this._update.bind(this);map.on('zoomend moveend',this._update);this._update();return div;},
        onRemove:function(map){map.off('zoomend moveend',this._update);},
        _update:function(){const c=this._map.getCenter(),z=this._map.getZoom();if(z==null){this._div.textContent='√âchelle ‚Äî';return;}const mpp=156543.03392*Math.cos(c.lat*Math.PI/180)/Math.pow(2,z);const denom=Math.max(1,Math.round(mpp/0.0002645833333));this._div.textContent='√âchelle ~ 1:'+denom.toLocaleString('fr-FR');}
      });
      map.whenReady(()=>{ map.addControl(new RatioControl()); });

      function layout(){ const H=document.querySelector('header.slim'); const h=Math.max(420, window.innerHeight - H.getBoundingClientRect().height - 16); mapEl.style.height=h+'px'; try{ map.invalidateSize(); }catch(_){ } }
      window.addEventListener('resize', layout); setTimeout(layout, 50);

      // Data & Layers
      const participants=[]; let uid=0; let vizCircle=null;
      const colors={producer:'#6D28D9', consumer:'#2e86de'};
      const participantLayer=L.layerGroup().addTo(map);
      const producerIcon=L.icon({iconUrl:'./icon-192.png',iconSize:[28,28],iconAnchor:[14,28],popupAnchor:[0,-24]});

      function selectedType(){ return document.querySelector('input[name="ptype"]:checked').value; }
      function currentDiameter(){ const sel=document.getElementById('limitSel').value; if(sel==='custom'){ const v=parseFloat(document.getElementById('customKm').value||'0'); return (isNaN(v)||v<=0)?20:v; } return parseFloat(sel); }
      function updateCount(){ const c=document.getElementById('count'); if(!c) return; const n=participants.length; const np=participants.filter(p=>p.type==='producer').length; c.textContent = n? `${n} point${n>1?'s':''} dont ${np} producteur${np>1?'s':''}.` : 'Aucun point.'; }

      function addParticipant(lat,lng,type,name){
        const id=++uid; const label=name || `${type} ${id}`;
        const m=(type==='producer')
          ? L.marker([lat,lng],{icon:producerIcon})
          : L.circleMarker([lat,lng],{radius:7,color:colors[type],weight:2,fillColor:colors[type],fillOpacity:0.3});
        m.addTo(participantLayer);
        const entry={id,name:label,type,lat,lng,marker:m};
        if(m.bindTooltip) m.bindTooltip(`${safeText(label)} (${type})`);
        if(m.on) m.on('contextmenu', ()=> removeParticipant(id));
        participants.push(entry);
        refreshACC(true);
      }
      function removeParticipant(id){
        const i=participants.findIndex(p=>p.id===id);
        if(i>-1){ participantLayer.removeLayer(participants[i].marker); participants.splice(i,1); refreshACC(); }
      }
      map.on('click', e=> addParticipant(e.latlng.lat, e.latlng.lng, selectedType()));

      function clearVizCircle(){ if(vizCircle){ map.removeLayer(vizCircle); vizCircle=null; } }
      function styleParticipants(center,R){
        participants.forEach(p=>{
          const d=haversineKm(center,{lat:p.lat,lng:p.lng});
          const inside=d<=R+eps;
          if(p.marker.setStyle){
            p.marker.setStyle({
              color: inside ? colors[p.type] : '#8b8b8b',
              weight: inside ? 3 : 2,
              fillColor: colors[p.type],
              fillOpacity: inside ? 0.5 : 0.15
            });
          }
        });
      }
      function refreshACC(autoFit=false){
        const D=currentDiameter(); const R=D/2;
        clearVizCircle();
        if(!participants.length){ tSet(statusEl,'Ajoutez un producteur et des consommateurs.'); return; }
        if(!participants.some(p=>p.type==='producer')){ tSet(statusEl,'Aucun producteur d√©tect√©.'); return; }

        const mec=minimalEnclosingCircle(participants.map(p=>({lat:p.lat,lng:p.lng})));
        if(!mec){ tSet(statusEl,'Centre libre non calculable.'); return; }
        const pass=mec.r<=R+eps;

        vizCircle=L.circle([mec.center.lat,mec.center.lng],{radius:R*1000,color:'#6D28D9',weight:2,fill:false,opacity:0.9,dashArray:'6 6'})
          .addTo(map).bindTooltip('Centre libre (visualisation) ‚Äî centre non d√©fini',{className:'center-free-tip'});

        styleParticipants(mec.center,R);

        if(autoFit && participants.length>1){
          const g=L.featureGroup(participants.map(p=>p.marker));
          map.fitBounds(g.getBounds().pad(0.25));
        }

        const outside=participants.filter(p=>haversineKm(mec.center,{lat:p.lat,lng:p.lng})>R+eps).map(p=>p.name||p.type);
        if(pass){ hSet(statusEl, `<strong>Conforme</strong> ‚Äî D=${esc(String(D))} km ¬∑ r*=${esc(mec.r.toFixed(2))} km ‚â§ D/2=${esc(R.toFixed(2))} km.`, 'ok'); }
        else{ hSet(statusEl, `<strong>Non conforme</strong> ‚Äî D=${esc(String(D))} km ¬∑ r*=${esc(mec.r.toFixed(2))} km > D/2=${esc(R.toFixed(2))} km ¬∑ Points limitants : ${outside.map(esc).join(', ')||'‚Äî'}`, 'ko'); }
      }

      // UI
      document.getElementById('limitSel').addEventListener('change', (e)=>{ const v=e.target.value; const custom=document.getElementById('customKm'); custom.style.display=(v==='custom')?'inline-block':'none'; refreshACC(); });
      document.getElementById('customKm').addEventListener('input', refreshACC);
      document.getElementById('clearBtn').onclick = ()=>{ participants.slice().forEach(p=> removeParticipant(p.id)); };
      document.getElementById('fitBtn').onclick = ()=>{ if(!participants.length) return; const g=L.featureGroup(participants.map(p=>p.marker)); map.fitBounds(g.getBounds().pad(0.25)); };

      // Geoloc
      let myMarker=null, myAccCircle=null;
      function clearMyLoc(){ if(myMarker){map.removeLayer(myMarker); myMarker=null;} if(myAccCircle){map.removeLayer(myAccCircle); myAccCircle=null;} }
      document.getElementById('locateBtn').addEventListener('click', ()=>{
        if(!navigator.geolocation){ tSet(statusEl,'G√©olocalisation non support√©e.'); return; }
        navigator.geolocation.getCurrentPosition(pos=>{
          const lat=pos.coords.latitude, lng=pos.coords.longitude, acc=pos.coords.accuracy||50;
          clearMyLoc();
          const myIcon=L.divIcon({className:'myloc-pin', html:`<svg width="28" height="28" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M16 2C10.477 2 6 6.477 6 12c0 7 10 18 10 18s10-11 10-18C26 6.477 21.523 2 16 2z" fill="#111827"/><circle cx="16" cy="12" r="5" fill="#34D399"/></svg>`, iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-28]});
          myMarker=L.marker([lat,lng],{icon:myIcon,zIndexOffset:1000}).addTo(map).bindTooltip('Vous √™tes ici');
          myAccCircle=L.circle([lat,lng],{radius:acc,color:'#34D399',weight:1,opacity:0.5,fillOpacity:0.06}).addTo(map);
          map.setView([lat,lng], 15);
          tSet(statusEl,`Localis√© (~¬±${Math.round(acc)} m).`);
        }, ()=> tSet(statusEl,'G√©olocalisation refus√©e / indisponible.'), {enableHighAccuracy:true, timeout:8000, maximumAge:30000});
      });

      // Impression
      function updatePrintHeader(){
        const D = (document.getElementById('limitSel').value==='custom'
          ? (parseFloat(document.getElementById('customKm').value)||20)
          : parseFloat(document.getElementById('limitSel').value));
        const n=participants.length, np=participants.filter(p=>p.type==='producer').length, nc=participants.filter(p=>p.type==='consumer').length;
        document.getElementById('printMeta').textContent = `D=${D} km ‚Äî Points: ${n} (Prod ${np}, Cons ${nc}) ‚Äî ${fmtDate(new Date())}`;
      }
      async function ensureTilesReady(timeout=2000){
        return new Promise(resolve=>{
          const start=Date.now(); const tiles=[...document.querySelectorAll('.leaflet-tile')];
          if(tiles.length===0){ resolve(); return; }
          let remaining=tiles.length; const done=()=>{ if(--remaining<=0 || (Date.now()-start)>timeout) resolve(); };
          tiles.forEach(img=>{ if(img.complete && img.naturalWidth>0){ done(); } else { img.addEventListener('load',done,{once:true}); img.addEventListener('error',done,{once:true}); } });
          setTimeout(resolve, timeout);
        });
      }
      document.getElementById('printBtn').onclick = async ()=>{ updatePrintHeader(); try{ map.invalidateSize(); }catch(_){ } await ensureTilesReady(2000); window.print(); };
      window.addEventListener('beforeprint', async ()=>{ updatePrintHeader(); try{ map.invalidateSize(); }catch(_){ } await ensureTilesReady(1500); });
      window.addEventListener('afterprint', ()=>{ setTimeout(()=>{ try{ map.invalidateSize(); }catch(_){ } }, 100); });

      // Search address
      async function geocodePhoton(q){ const url='https://photon.komoot.io/api/?q='+encodeURIComponent(q)+'&lang=fr&limit=5'; const r=await fetch(url); if(!r.ok) throw new Error('Photon'); const j=await r.json(); return (j.features||[]).map(f=>{ const g=f.geometry, p=f.properties||{}; if(!g||!g.coordinates) return null; const lat=g.coordinates[1], lng=g.coordinates[0]; const label=[p.housenumber,p.street,p.name,p.city,p.postcode].filter(Boolean).join(' '); return {label: label || p.name || q, lat, lng}; }).filter(Boolean); }
      async function geocodeNominatim(q){ const url='https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=5&q='+encodeURIComponent(q); const r=await fetch(url,{headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error('Nominatim'); const j=await r.json(); return j.map(o=>({label:o.display_name,lat:parseFloat(o.lat),lng:parseFloat(o.lon)})); }
      async function searchAddress(q){ const box=document.getElementById('searchResults'); if(!box) return; box.textContent='Recherche‚Ä¶'; let res=[]; try{ res=await geocodePhoton(q); }catch(_){ } if(!res.length){ try{ res=await geocodeNominatim(q); }catch(_){ } }
        if(!res.length){ box.textContent='Aucun r√©sultat ou service indisponible.'; return; }
        const ul=document.createElement('ul'); res.forEach(r=>{ const li=document.createElement('li'); const a=document.createElement('a'); a.href='#'; a.textContent=r.label; a.dataset.lat=String(r.lat); a.dataset.lng=String(r.lng); a.dataset.label=r.label; li.appendChild(a); ul.appendChild(li); }); box.innerHTML=''; box.appendChild(ul);
      }

      // Diagnostics
      window.addEventListener('error', e=>{ tSet(statusEl,'Erreur JS : '+e.message); });
      window.addEventListener('unhandledrejection', e=>{ tSet(statusEl,'Erreur Promesse : '+(e.reason?.message||e.reason)); });

      // Auto set size
      layout();
      tSet(statusEl,'Pr√™t.');

      // Click add participant
      document.getElementById('map').addEventListener('click', (e)=>{ /* Leaflet handles */ });

      // Keyboard shortcuts, etc. (optionnel)
    } // fin initApp()
  </script>
</body>
</html>
