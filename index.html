<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACC ‚Äì Centre libre (Diam√®tre) ¬∑ PV ¬∑ AURA</title>

  <!-- Leaflet CSS (+ fallback) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#37C3AF">

  <style>
    :root{--ink:#1c1c1c;--line:#e6eaea;--muted:#f7f8f8;--ok:#0f766e;--bad:#b91c1c;--brand:#37C3AF}
    html,body{height:100%}
    body{margin:0;font-family:'Open Sans', system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;color:var(--ink);background:#fff}

    /* Header */
    header.slim{display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--line);padding:6px 8px}
    .brand{display:flex;align-items:center;gap:8px}
    .brand svg{height:26px;width:auto;border-radius:6px;box-shadow:0 0 0 1px rgba(0,0,0,.06)}
    .brand .name{font-family:'Montserrat',sans-serif;font-weight:700;letter-spacing:.3px}
    .controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:space-between;width:100%}
    .group{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .dot{width:10px;height:10px;border-radius:50%}
    .prod{background:#6D28D9}.cons{background:#2e86de}.poi{background:#E10600}

    .btn{padding:6px 8px;border:1px solid var(--brand);border-radius:10px;background:var(--brand);color:#fff;cursor:pointer;font-weight:700}
    .btn.icon{padding:6px 8px;min-width:36px;display:inline-flex;align-items:center;justify-content:center}
    .btn.secondary{background:#fff;color:#0f4f47;border-color:var(--brand)}
    select, input[type="number"], input[type="text"]{border:1px solid var(--line);border-radius:8px;padding:6px 8px}

    #status{margin:6px 8px 0;border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff;font-size:14px}
    #status.ok{background:rgba(55,195,175,.08);border-color:rgba(55,195,175,.45);color:#116a60}
    #status.ko{background:#fff5f3;border-color:#f6d2cc}

    #map{min-height:420px;margin:8px;border:1px solid var(--line);border-radius:12px;position:relative}

    /* Drawer */
    #drawer{position:fixed;inset:auto 0 0 auto;top:0;height:100vh;width:380px;max-width:92vw;background:#fff;border-left:1px solid var(--line);box-shadow:-8px 0 24px rgba(0,0,0,.06);transform:translateX(100%);transition:.25s ease;z-index:5000;display:flex;flex-direction:column}
    #drawer.open{transform:none}
    #drawer header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
    #drawer h2{font-family:'Montserrat',sans-serif;font-size:16px;margin:0}
    #drawer .content{padding:12px;overflow:auto}
    fieldset{border:1px solid var(--line);border-radius:10px;margin:10px 0;padding:10px}
    legend{padding:0 6px;color:#475569;font-size:12px}
    textarea{width:100%;min-height:80px;resize:vertical;border:1px solid var(--line);border-radius:8px;padding:8px}
    .small{font-size:12px;color:#64748b}
    .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}

    /* L√©gende carte (√©cran) */
    .legend-overlay{position:absolute;bottom:10px;left:10px;background:rgba(255,255,255,.9);border:1px solid var(--line);border-radius:8px;padding:6px 8px;display:flex;gap:10px;align-items:center;font-size:12px}
    .legend-overlay .item{display:flex;align-items:center;gap:6px}

    /* √âchelle 1:n */
    .leaflet-control.ratio-control{
      background:rgba(255,255,255,.95);border:1px solid var(--line);border-radius:8px;
      padding:4px 8px;font-size:12px;z-index:1000
    }

    .center-free-tip{background:#111827;color:#fff;padding:2px 6px;border-radius:6px;font-size:11px;box-shadow:0 2px 8px rgba(0,0,0,.2)}

    /* Chronologie ACC */
    .tl-table{width:100%;border-collapse:collapse;font-size:13px}
    .tl-table th,.tl-table td{border:1px solid var(--line);padding:6px}
    .tl-table th{background:#f9fafb;text-align:left}
    .tl-done{color:#0f766e;font-weight:600}
    .tl-overdue{color:#b91c1c;font-weight:600}

    /* PRINT */
    .print-header{display:none}
    .print-legend{display:none}
    @media print{
      @page { size: A4 landscape; margin: 12mm; }
      header.slim, #drawer, #status{ display:none !important; }
      body{ background:#fff; }
      .print-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
      .print-header .left{display:flex;align-items:center;gap:8px}
      .print-header .brand svg{height:26px}
      .print-header .title{font-family:'Montserrat',sans-serif;font-weight:700}
      #map{ height:170mm !important; min-height:170mm !important; margin:0; border:0 }
      .leaflet-pane, .leaflet-map-pane, .leaflet-tile, .leaflet-marker-icon, .leaflet-marker-shadow{ transform:none !important; animation:none !important; }
      .leaflet-container{ background:#fff !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      .leaflet-tile{ filter:none !important; }
      .legend-overlay{ display:none; }
      .print-legend{display:grid;grid-template-columns:auto 1fr;gap:4px 8px;margin-top:8px;font-size:12px}
    }
    @media (max-width: 720px){ header.slim{flex-wrap:wrap} .controls{gap:6px} }
  </style>
</head>
<body>
  <!-- BARRE -->
  <header class="slim">
    <div class="brand" role="img" aria-label="Echome √ânergies">
      <svg viewBox="0 0 120 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="0" y="0" width="120" height="32" rx="6" fill="#37C3AF"/>
        <text x="60" y="19" text-anchor="middle" font-family="Montserrat, Arial, sans-serif" font-size="14" fill="#ffffff">ECHOME</text>
      </svg>
      <span class="name">Echome √ânergies</span>
    </div>

    <div class="controls">
      <!-- Type de point √† ajouter -->
      <div class="group" role="radiogroup" aria-label="Type de point (ACC)">
        <label class="chip"><input type="radio" name="ptype" value="consumer" checked> <span class="dot cons"></span>Cons.</label>
        <label class="chip"><input type="radio" name="ptype" value="producer"> <span class="dot prod"></span>Prod.</label>
      </div>

      <!-- Diam√®tre ACC -->
      <div class="group" aria-label="Diam√®tre">
        <label class="small">Diam√®tre :</label>
        <select id="limitSel" aria-label="Diam√®tre autoris√©">
          <option value="2">2 km</option>
          <option value="10">10 km</option>
          <option value="20" selected>20 km</option>
          <option value="custom">Perso</option>
        </select>
        <input id="customKm" type="number" min="0" step="0.1" placeholder="km" style="width:90px;display:none" aria-label="Diam√®tre personnalis√©">
        <label class="small" title="Si un SIS participe, le diam√®tre = 20 km">
          <input type="checkbox" id="sisCheck"> SIS participant ‚Üí 20 km
        </label>
      </div>

      <!-- Actions -->
      <div class="group">
        <button id="openProjBtn" class="btn icon" title="Ouvrir un fichier projet‚Ä¶" aria-label="Ouvrir un fichier projet">üìÇ</button>
        <button id="locateBtn" class="btn icon" title="Me localiser" aria-label="Me localiser">üìç</button>
        <button id="fitBtn" class="btn icon" title="Ajuster la vue" aria-label="Ajuster la vue">üó∫Ô∏è</button>
        <button id="printBtn" class="btn icon" title="Exporter en PDF" aria-label="Exporter en PDF">üñ®Ô∏è</button>
        <button id="clearBtn" class="btn icon" title="Effacer les participants" aria-label="Effacer les participants">üóëÔ∏è</button>
        <button id="gearBtn" class="btn secondary" title="Options avanc√©es">‚öôÔ∏è Options</button>
      </div>
    </div>
  </header>

  <!-- En-t√™te impression -->
  <div class="print-header" id="printHeader">
    <div class="left brand">
      <svg viewBox="0 0 120 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="0" y="0" width="120" height="32" rx="6" fill="#37C3AF"/>
        <text x="60" y="19" text-anchor="middle" font-family="Montserrat, Arial, sans-serif" font-size="14" fill="#ffffff">ECHOME</text>
      </svg>
      <span class="title">ACC ‚Äì Centre libre (diam√®tre)</span>
    </div>
    <div class="right small" id="printMeta"></div>
  </div>

  <div id="status" role="status" aria-live="polite">Initialisation‚Ä¶</div>
  <div id="map" aria-label="Carte interactive">
    <div class="legend-overlay" aria-hidden="true">
      <div class="item"><span class="dot prod"></span>Producteur</div>
      <div class="item"><span class="dot cons"></span>Consommateur</div>
      <div class="item"><span class="dot poi"></span>POI incendie (SDIS/SDMIS/STIS/SLIS‚Ä¶)</div>
    </div>
  </div>

  <!-- Drawer -->
  <aside id="drawer" aria-hidden="true" aria-label="Options avanc√©es">
    <header>
      <h2>Options avanc√©es</h2>
      <button id="drawerClose" class="btn secondary">Fermer</button>
    </header>
    <div class="content">
      <fieldset>
        <legend>Projet</legend>
        <div class="row">
          <label class="small">Nom du projet :</label>
          <input id="projName" type="text" placeholder="Projet 1" style="flex:1">
        </div>
        <div class="row" style="margin-top:6px">
          <button id="saveLocal" class="btn">Enregistrer (local)</button>
          <select id="projList" style="flex:1" aria-label="Projets sauvegard√©s"></select>
          <button id="loadLocal" class="btn secondary">Charger</button>
          <button id="delLocal" class="btn secondary">Supprimer</button>
        </div>
        <div class="row" style="margin-top:6px">
          <button id="exportJson" class="btn">Exporter fichier</button>
          <input id="importJson" type="file" accept="application/json">
        </div>
      </fieldset>

      <fieldset>
        <legend>Import rapide (participants ACC)</legend>
        <div class="small">Format : Nom;Lat;Lon;Type ‚Äî Types : consumer / producer</div>
        <textarea id="bulk" placeholder="Usine A;45.76;4.84;producer&#10;Coll√®ge B;45.77;4.86;consumer"></textarea>
        <div style="margin-top:8px"><button id="importBtn" class="btn">Importer</button></div>
      </fieldset>

      <fieldset>
        <legend>Points d‚Äôint√©r√™t ‚ÄúIncendie & Secours‚Äù</legend>
        <div class="small">OSM/Overpass ‚Äì Is√®re. Noms/op√©rateurs contenant : SDIS, SDMIS, STIS, SLIS (autres casernes incluses).</div>
        <div class="row" style="margin-top:6px">
          <button id="loadPoiIsere" class="btn">Charger POI Is√®re</button>
          <label class="small"><input type="checkbox" id="togglePoi" checked> Afficher POI</label>
        </div>
        <div class="small" style="margin-top:6px">POI : <span id="poiStats">0 charg√©(s)</span> ‚Äî Dans D/2 : <span id="poiInRange">0</span></div>
      </fieldset>

      <fieldset>
        <legend>Donn√©es AURA (WMS/WFS DatARA)</legend>
        <div class="small" style="margin-bottom:6px">
          Source: DatARA (WMS/WFS). Choisis une couche ou un type puis affiche-la sur la carte.
        </div>

        <!-- WMS -->
        <div class="row" style="gap:6px;align-items:flex-start">
          <div style="flex:1;min-width:260px">
            <div class="small">WMS URL</div>
            <input id="wmsUrl" type="text" style="width:100%" value="https://datacarto.open-datara.fr/wms">
          </div>
          <div><button id="wmsListBtn" class="btn secondary">Lister couches</button></div>
        </div>
        <div class="row" style="margin-top:6px">
          <select id="wmsLayerSel" style="flex:1;min-width:260px"></select>
          <button id="wmsAddBtn" class="btn">Afficher</button>
          <label class="small" style="display:flex;align-items:center;gap:6px">Opacit√© <input id="wmsOpacity" type="range" min="0" max="1" step="0.05" value="0.8"></label>
        </div>

        <!-- WFS -->
        <div class="row" style="gap:6px;align-items:flex-start;margin-top:12px">
          <div style="flex:1;min-width:260px">
            <div class="small">WFS URL</div>
            <input id="wfsUrl" type="text" style="width:100%" value="https://datacarto.open-datara.fr/wfs">
          </div>
          <div><button id="wfsListBtn" class="btn secondary">Lister types</button></div>
        </div>
        <div class="row" style="margin-top:6px">
          <select id="wfsTypeSel" style="flex:1;min-width:260px"></select>
          <button id="wfsLoadBtn" class="btn">Charger (emprise)</button>
          <label class="small" title="Limiter le nombre d'entit√©s">Max <input id="wfsMaxFeat" type="number" min="50" step="50" value="1000" style="width:80px"></label>
        </div>

        <div class="small" style="margin-top:8px">
          Couches actives : <span id="extLayersCount">0</span>
          ‚Äî <a href="#" id="extToggleAll">Afficher/Masquer</a> ¬∑
          <a href="#" id="extClearAll">Supprimer</a>
        </div>
      </fieldset>

      <fieldset>
        <legend>Rechercher une adresse</legend>
        <div style="display:flex;gap:6px;align-items:center">
          <input id="searchQ" type="text" placeholder="Adresse, commune, code postal" style="flex:1" aria-label="Rechercher une adresse">
          <button id="searchBtn" class="btn">Rechercher</button>
        </div>
        <div id="searchResults" class="small" aria-live="polite" style="margin-top:6px"></div>
      </fieldset>

      <fieldset>
        <legend>Producteur par d√©faut</legend>
        <div class="small">Adresse : <em>210 Les Espinasses, 38250 Villard-de-Lans</em></div>
        <div style="margin-top:6px"><button id="resetDefaultBtn" class="btn secondary">R√©initialiser le d√©faut</button></div>
      </fieldset>

      <fieldset>
        <legend>Chronologie ACC</legend>
        <div class="small" style="margin-bottom:6px">
          R√©f√©rence : Enogrid ‚Äî Chronologie ACC (indicative). √âtapes non exhaustives.
        </div>
        <div id="accTimeline"></div>
        <div class="row" style="margin-top:8px">
          <button id="tlAddStep" class="btn secondary">Ajouter une √©tape</button>
          <button id="tlExportCsv" class="btn">Exporter CSV</button>
          <button id="tlClear" class="btn secondary">R√©initialiser</button>
        </div>
      </fieldset>

      <div class="small" style="margin-top:10px">Participants : <span id="count">Aucun point.</span></div>
    </div>
  </aside>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
    // Fallback si unpkg bloqu√©
    (function ensureLeaflet(cb){ if(window.L){ cb(); return; }
      var s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js';
      s.crossOrigin='anonymous'; s.referrerPolicy='no-referrer'; s.onload=cb;
      s.onerror=function(){ document.getElementById('status').textContent='Erreur : Leaflet bloqu√© par le r√©seau.'; };
      document.head.appendChild(s);
    })(initApp);

    function initApp(){
      const statusEl = document.getElementById('status');
      const poiStatsEl = document.getElementById('poiStats');
      const poiInRangeEl = document.getElementById('poiInRange');
      const mapEl = document.getElementById('map');

      // Utils
      const eps = 1e-9; const toRad = d => d*Math.PI/180;
      const esc = s => String(s||'').replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
      const safeText = s => String(s ?? '');
      const tSet = (el,txt,cls='')=>{ el.className=cls; el.textContent=txt; };
      const hSet = (el,html,cls='')=>{ el.className=cls; el.innerHTML=html; };
      const fmtDate=(d)=>{ const p=n=>String(n).padStart(2,'0'); return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`; };
      function haversineKm(a,b){ const R=6371; const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng);
        const lat1=toRad(a.lat), lat2=toRad(b.lat);
        const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }

      // MEC utils (points: {lat,lng})
      function projectLocal(pointsLL){ const lat0=pointsLL.reduce((s,p)=>s+p.lat,0)/pointsLL.length; const lon0=pointsLL.reduce((s,p)=>s+p.lng,0)/pointsLL.length;
        const P=pointsLL.map(p=>({x:(p.lng-lon0)*111.32*Math.cos(lat0*Math.PI/180), y:(p.lat-lat0)*111.32})); return {lat0,lon0,P}; }
      function unprojectLocal(lat0,lon0,x,y){ return {lat:lat0 + y/111.32, lng: lon0 + x/(111.32*Math.cos(lat0*Math.PI/180))}; }
      function dist2(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return dx*dx+dy*dy; }
      function circleBy2(a,b){ return {x:(a.x+b.x)/2,y:(a.y+b.y)/2,r:Math.sqrt(dist2(a,b))/2}; }
      function circleBy3(a,b,c){ const A=b.x-a.x, B=b.y-a.y, C=c.x-a.x, D=c.y-a.y; const E=A*(a.x+b.x)+B*(a.y+b.y); const F=C*(a.x+c.x)+D*(a.y+c.y); const G=2*(A*(c.y-b.y)-B*(c.x-b.x));
        if(Math.abs(G)<1e-12) return null; const x=(D*E-B*F)/G, y=(A*F-C*E)/G, r=Math.hypot(x-a.x,y-a.y); return {x,y,r}; }
      function inCircle(c,p){ return Math.hypot(c.x-p.x,c.y-p.y) <= c.r + 1e-9; }
      function minimalEnclosingCircle(pointsLL){
        if(pointsLL.length===0) return null; if(pointsLL.length===1) return {center:pointsLL[0], r:0};
        const {lat0,lon0,P}=projectLocal(pointsLL);
        let best=null;
        for(let i=0;i<P.length;i++) for(let j=i+1;j<P.length;j++){
          const c=circleBy2(P[i],P[j]); if(P.every(p=>inCircle(c,p))) if(!best||c.r<best.r) best=c;
        }
        for(let i=0;i<P.length;i++) for(let j=i+1;j<P.length;j++) for(let k=j+1;k<P.length;k++){
          const c=circleBy3(P[i],P[j],P[k]); if(!c) continue; if(P.every(p=>inCircle(c,p))) if(!best||c.r<best.r) best=c;
        }
        if(!best){ let max=-1,a=-1,b=-1; for(let i=0;i<P.length;i++) for(let j=i+1;j<P.length;j++){ const d=dist2(P[i],P[j]); if(d>max){max=d;a=i;b=j;} } best=circleBy2(P[a],P[b]); }
        const center=unprojectLocal(lat0,lon0,best.x,best.y); return {center, r:best.r};
      }

      // Carte
      const map = L.map('map', { zoomControl:true }).setView([45.3, 5.6], 8);
      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'¬© OpenStreetMap' });
      const carto = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'¬© Carto, ¬© OpenStreetMap' });
      osm.on('tileerror', ()=>{ if(!map.hasLayer(carto)) carto.addTo(map); if(map.hasLayer(osm)) map.removeLayer(osm); tSet(statusEl,'Fond OSM bloqu√© ‚Üí Carto Light.'); });
      osm.addTo(map);
      L.control.scale({imperial:false, metric:true, maxWidth:120}).addTo(map);

      /* √âchelle 1:n (ratio approximatif) */
      const RatioControl = L.Control.extend({
        options: { position: 'topright' },
        onAdd: function(map){
          const div = L.DomUtil.create('div','leaflet-control ratio-control');
          this._div = div; this._map = map; this._update = this._update.bind(this);
          map.on('zoomend moveend', this._update); this._update(); return div;
        },
        onRemove: function(map){ map.off('zoomend moveend', this._update); },
        _update: function(){
          const c=this._map.getCenter(), z=this._map.getZoom();
          if(z==null){ this._div.textContent='√âchelle ‚Äî'; return; }
          const mpp = 156543.03392 * Math.cos(c.lat*Math.PI/180) / Math.pow(2, z);
          const denom = Math.max(1, Math.round(mpp / 0.0002645833333)); // 0.26458 mm/px
          this._div.textContent = '√âchelle ~ 1:' + denom.toLocaleString('fr-FR');
        }
      });
      map.whenReady(() => { map.addControl(new RatioControl()); });

      function layout(){ const H=document.querySelector('header.slim'); const h=Math.max(420, window.innerHeight - H.getBoundingClientRect().height - 16); mapEl.style.height=h+'px'; try{ map.invalidateSize(); }catch(_){ } }
      window.addEventListener('resize', layout); setTimeout(layout, 50);

      // Donn√©es
      const participants=[]; // {id,name,type,lat,lng,marker}
      const pois=[];         // {id,name,kind,lat,lng,marker}
      let uid=0;
      let vizCircle=null; // cercle visuel ACC (diam√®tre)
      const colors={producer:'#6D28D9', consumer:'#2e86de', poi:'#E10600'};
      const participantLayer = L.layerGroup().addTo(map);
      const poiLayer = L.layerGroup().addTo(map);
      window.__participants__ = participants;

      // UI helpers
      function selectedType(){ return document.querySelector('input[name="ptype"]:checked').value; }
      function currentDiameter(){
        const sis = document.getElementById('sisCheck').checked;
        if(sis) return 20;
        const sel=document.getElementById('limitSel').value;
        if(sel==='custom'){ const v=parseFloat(document.getElementById('customKm').value||'0'); return (isNaN(v)||v<=0)?20:v; }
        return parseFloat(sel);
      }
      function updateCount(){ const c=document.getElementById('count'); const n=participants.length; const np=participants.filter(p=>p.type==='producer').length; c.textContent = n? `${n} point${n>1?'s':''} dont ${np} producteur${np>1?'s':''}.` : 'Aucun point.'; }
      function setPoiStats(){ poiStatsEl.textContent = `${pois.length} charg√©(s)`; }

      // Ajout PARTICIPANT (clic carte)
      function addParticipant(lat,lng,type,name){
        const id=++uid; const label=name || `${type} ${id}`;
        const m=L.circleMarker([lat,lng],{radius:7,color:colors[type],weight:2,fillColor:colors[type],fillOpacity:0.3}).addTo(participantLayer);
        const entry={id,name:label,type,lat,lng,marker:m};
        m.bindTooltip(`${safeText(label)} (${type})`);
        m.bindPopup(makeParticipantPopup(entry));
        m.on('contextmenu', ()=> removeParticipant(id));
        participants.push(entry);
        refreshACC(true);
      }
      function makeParticipantPopup(entry){
        const wrap=document.createElement('div');
        const title=document.createElement('strong'); title.textContent=entry.name||''; wrap.appendChild(title);
        wrap.appendChild(document.createElement('br'));
        wrap.appendChild(document.createTextNode(entry.type));
        const box=document.createElement('div'); box.style.marginTop='6px'; box.style.display='flex'; box.style.gap='6px'; box.style.flexWrap='wrap';
        const bRen=document.createElement('button'); bRen.className='btn secondary'; bRen.textContent='Renommer';
        bRen.onclick=()=>{ const nn=prompt('Nouveau nom :', entry.name||''); if(nn&&nn.trim()){ entry.name=nn.trim(); entry.marker.setPopupContent(makeParticipantPopup(entry)); entry.marker.bindTooltip(`${entry.name} (${entry.type})`); } };
        const bDel=document.createElement('button'); bDel.className='btn secondary'; bDel.textContent='Supprimer';
        bDel.onclick=()=> removeParticipant(entry.id);
        box.appendChild(bRen); box.appendChild(bDel); wrap.appendChild(box);
        return wrap;
      }
      function removeParticipant(id){
        const i=participants.findIndex(p=>p.id===id);
        if(i>-1){ participantLayer.removeLayer(participants[i].marker); participants.splice(i,1); refreshACC(); }
      }
      map.on('click', e=> addParticipant(e.latlng.lat, e.latlng.lng, selectedType()));

      // Ajout POI (ne d√©clenche pas le calcul)
      function addPOI(lat,lng,kind,name){
        const id=++uid; const label=name||kind||'POI';
        const m=L.circleMarker([lat,lng],{radius:6,color:colors.poi,weight:2,fillColor:colors.poi,fillOpacity:0.25}).addTo(poiLayer);
        const entry={id,name:label,kind,lat,lng,marker:m};
        m.bindTooltip(`${safeText(label)} ‚Äî ${kind||'incendie'}`);
        m.bindPopup(makePoiPopup(entry));
        pois.push(entry);
        setPoiStats();
        updatePoiInRange();
      }
      function makePoiPopup(entry){
        const wrap=document.createElement('div');
        const title=document.createElement('strong'); title.textContent=entry.name||'POI'; wrap.appendChild(title);
        wrap.appendChild(document.createElement('br'));
        wrap.appendChild(document.createTextNode(entry.kind||'incendie'));
        return wrap;
      }

      // ACC core (ne d√©pend que des participants)
      function clearVizCircle(){ if(vizCircle){ map.removeLayer(vizCircle); vizCircle=null; } }
      function styleParticipants(center, R){
        participants.forEach(p=>{
          const d = haversineKm(center,{lat:p.lat,lng:p.lng});
          const inside = d <= R + eps;
          p.marker.setStyle({
            color: inside ? colors[p.type] : '#8b8b8b',
            weight: inside ? 3 : 2,
            fillColor: colors[p.type],
            fillOpacity: inside ? 0.5 : 0.15
          });
        });
      }
      function refreshACC(autoFit=false){
        updateCount();
        const D=currentDiameter(); const R=D/2;
        clearVizCircle();
        if(!participants.length){ tSet(statusEl,'Ajoutez un producteur et des consommateurs.'); poiInRangeEl.textContent='0'; return; }
        if(!participants.some(p=>p.type==='producer')){ tSet(statusEl,'Aucun producteur d√©tect√©.'); poiInRangeEl.textContent='0'; return; }

        const mec = minimalEnclosingCircle(participants.map(p=>({lat:p.lat,lng:p.lng})));
        if(!mec){ tSet(statusEl,'Centre libre non calculable.'); poiInRangeEl.textContent='0'; return; }
        const pass = mec.r <= R + eps;

        vizCircle = L.circle([mec.center.lat,mec.center.lng],{ radius:R*1000,color:'#6D28D9',weight:2,fill:false,opacity:0.9,dashArray:'6 6' })
          .addTo(map).bindTooltip('Centre libre (visualisation) ‚Äî centre non d√©fini',{className:'center-free-tip'});

        styleParticipants(mec.center, R);

        if(autoFit && participants.length>1){
          const g=L.featureGroup(participants.map(p=>p.marker));
          map.fitBounds(g.getBounds().pad(0.25));
        }

        const outside = participants.filter(p=> haversineKm(mec.center,{lat:p.lat,lng:p.lng}) > R + eps).map(p=> p.name||p.type);
        if(pass){
          hSet(statusEl, `<strong>Conforme</strong> ‚Äî D=${esc(String(D))} km ¬∑ r*=${esc(mec.r.toFixed(2))} km ‚â§ D/2=${esc(R.toFixed(2))} km.`, 'ok');
        }else{
          hSet(statusEl, `<strong>Non conforme</strong> ‚Äî D=${esc(String(D))} km ¬∑ r*=${esc(mec.r.toFixed(2))} km > D/2=${esc(R.toFixed(2))} km ¬∑ Points limitants : ${outside.map(esc).join(', ')||'‚Äî'}`, 'ko');
        }

        updatePoiInRange(mec.center, R); // info uniquement
      }

      function updatePoiInRange(center=null, R=null){
        if(!center || R==null){
          if(!vizCircle){ poiInRangeEl.textContent='0'; return; }
          center = vizCircle.getLatLng(); R = (vizCircle.getRadius()||0)/1000;
        }
        let cnt=0;
        pois.forEach(p=>{
          const inside = haversineKm(center,{lat:p.lat,lng:p.lng}) <= R + eps;
          if(inside) cnt++;
          p.marker.setStyle({
            color: inside ? colors.poi : '#8b8b8b',
            weight: inside ? 4 : 2,
            fillColor: colors.poi,
            fillOpacity: inside ? 0.55 : 0.15
          });
          p.marker.bindTooltip(`${safeText(p.name)} ‚Äî ${inside ? 'dans D/2' : 'hors D/2'}`);
        });
        poiInRangeEl.textContent = String(cnt);
      }

      // UI top bar
      document.getElementById('limitSel').addEventListener('change', (e)=>{ const v=e.target.value; const custom=document.getElementById('customKm'); custom.style.display=(v==='custom')?'inline-block':'none'; refreshACC(); });
      document.getElementById('customKm').addEventListener('input', refreshACC);
      document.getElementById('clearBtn').onclick = ()=>{ participants.slice().forEach(p=> removeParticipant(p.id)); };
      document.getElementById('fitBtn').onclick = ()=>{ if(!participants.length) return; const g=L.featureGroup(participants.map(p=>p.marker)); map.fitBounds(g.getBounds().pad(0.25)); };

      // SIS participant ‚Üí force D=20 km (d√©sactive le s√©lecteur)
      const sisCheck = document.getElementById('sisCheck');
      sisCheck.addEventListener('change', ()=>{
        const sel=document.getElementById('limitSel');
        const custom=document.getElementById('customKm');
        if(sisCheck.checked){ sel.disabled=true; custom.disabled=true; }
        else { sel.disabled=false; custom.disabled=false; }
        refreshACC();
      });

      // Bouton ‚ÄúOuvrir un fichier projet‚Ä¶‚Äù
      document.getElementById('openProjBtn').onclick = () => {
        const inp = document.getElementById('importJson');
        if (inp) inp.click();
      };
      // Cmd/Ctrl + O (hors saisie)
      window.addEventListener('keydown', (e) => {
        const tag = (e.target && e.target.tagName || '').toUpperCase();
        const typing = tag === 'INPUT' || tag === 'TEXTAREA' || (e.target && e.target.isContentEditable);
        if (typing) return;
        if ((e.metaKey || e.ctrlKey) && (e.key || '').toLowerCase() === 'o') {
          e.preventDefault();
          const inp = document.getElementById('importJson');
          if (inp) inp.click();
        }
      });

      // Localisation
      let myMarker=null, myAccCircle=null;
      function clearMyLoc(){ if(myMarker){map.removeLayer(myMarker); myMarker=null;} if(myAccCircle){map.removeLayer(myAccCircle); myAccCircle=null;} }
      document.getElementById('locateBtn').addEventListener('click', ()=>{
        if(!navigator.geolocation){ tSet(statusEl,'G√©olocalisation non support√©e.'); return; }
        navigator.geolocation.getCurrentPosition(pos=>{
          const lat=pos.coords.latitude, lng=pos.coords.longitude, acc=pos.coords.accuracy||50;
          clearMyLoc();
          const myIcon=L.divIcon({className:'myloc-pin', html:`<svg width="28" height="28" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M16 2C10.477 2 6 6.477 6 12c0 7 10 18 10 18s10-11 10-18C26 6.477 21.523 2 16 2z" fill="#111827"/><circle cx="16" cy="12" r="5" fill="#34D399"/></svg>`, iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-28]});
          myMarker=L.marker([lat,lng],{icon:myIcon,zIndexOffset:1000}).addTo(map).bindTooltip('Vous √™tes ici');
          myAccCircle=L.circle([lat,lng],{radius:acc,color:'#34D399',weight:1,opacity:0.5,fillOpacity:0.06}).addTo(map);
          map.setView([lat,lng], 15);
          tSet(statusEl,`Localis√© (~¬±${Math.round(acc)} m).`);
        }, ()=> tSet(statusEl,'G√©olocalisation refus√©e / indisponible.'), {enableHighAccuracy:true, timeout:8000, maximumAge:30000});
      });

      // Drawer
      const drawer = document.getElementById('drawer');
      document.getElementById('gearBtn').onclick = ()=>{ refreshProjectList(); drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); };
      document.getElementById('drawerClose').onclick = ()=>{ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); };

      // Projets (participants seulement)
      function captureState(){ return {
        name: (document.getElementById('projName').value||'Projet 1').trim()||'Projet 1',
        settings: { diameterSel: document.getElementById('limitSel').value, customKm: document.getElementById('customKm').value, sis: document.getElementById('sisCheck').checked },
        participants: participants.map(p=>({name:p.name, lat:p.lat, lng:p.lng, type:p.type}))
      }; }
      function applyState(st){
        participants.slice().forEach(p=> removeParticipant(p.id));
        document.getElementById('projName').value = st.name || 'Projet';
        document.getElementById('limitSel').value = st.settings?.diameterSel || '20';
        document.getElementById('customKm').value = st.settings?.customKm || '';
        document.getElementById('sisCheck').checked = !!(st.settings?.sis);
        const custom=document.getElementById('customKm'); const sel=document.getElementById('limitSel');
        custom.style.display = (sel.value==='custom')?'inline-block':'none';
        if(document.getElementById('sisCheck').checked){ sel.disabled=true; custom.disabled=true; } else { sel.disabled=false; custom.disabled=false; }
        (st.participants||[]).forEach(p=> addParticipant(p.lat, p.lng, p.type, p.name));
        refreshACC(true);
      }
      function lsKey(name){ return 'acc_project:'+name; }
      function refreshProjectList(){ const sel=document.getElementById('projList'); const keys=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k && k.startsWith('acc_project:')) keys.push(k.slice('acc_project:'.length)); } keys.sort((a,b)=>a.localeCompare(b)); sel.innerHTML=''; keys.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
      document.getElementById('saveLocal').onclick = ()=>{ const st=captureState(); localStorage.setItem(lsKey(st.name), JSON.stringify(st)); refreshProjectList(); tSet(statusEl,'Projet enregistr√© (local).'); };
      document.getElementById('loadLocal').onclick = ()=>{ const sel=document.getElementById('projList'); const n=sel.value; if(!n) return; try{ const st=JSON.parse(localStorage.getItem(lsKey(n))); if(st) applyState(st); tSet(statusEl,'Projet charg√©.'); }catch(_){ tSet(statusEl,'Chargement impossible.'); }};
      document.getElementById('delLocal').onclick = ()=>{ const sel=document.getElementById('projList'); const n=sel.value; if(!n) return; localStorage.removeItem(lsKey(n)); refreshProjectList(); tSet(statusEl,'Projet supprim√©.'); };

      document.getElementById('exportJson').onclick = ()=>{ const st=captureState(); const blob=new Blob([JSON.stringify(st,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=(st.name||'projet_acc')+'.json'; a.click(); URL.revokeObjectURL(url); };
      document.getElementById('importJson').addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; try{ const txt=await f.text(); const st=JSON.parse(txt); applyState(st); tSet(statusEl,'Projet import√©.'); }catch(_){ tSet(statusEl,'Fichier invalide.'); } });

      // Impression fiable
      function updatePrintHeader(){
        const name=(document.getElementById('projName').value||'Projet 1').trim()||'Projet 1';
        const D=currentDiameter(); const n=participants.length, np=participants.filter(p=>p.type==='producer').length, nc=participants.filter(p=>p.type==='consumer').length;
        document.getElementById('printMeta').textContent = `${name} ‚Äî D=${D} km ‚Äî Points: ${n} (Prod ${np}, Cons ${nc}) ‚Äî ${fmtDate(new Date())}`;
      }
      async function ensureTilesReady(timeout=2000){
        return new Promise(resolve=>{
          const start=Date.now(); const tiles=[...document.querySelectorAll('.leaflet-tile')];
          if(tiles.length===0){ resolve(); return; }
          let remaining=tiles.length; const done=()=>{ if(--remaining<=0 || (Date.now()-start)>timeout) resolve(); };
          tiles.forEach(img=>{ if(img.complete && img.naturalWidth>0){ done(); } else { img.addEventListener('load',done,{once:true}); img.addEventListener('error',done,{once:true}); } });
          setTimeout(resolve, timeout);
        });
      }
      document.getElementById('printBtn').onclick = async ()=>{ updatePrintHeader(); try{ map.invalidateSize(); }catch(_){ } await ensureTilesReady(2000); window.print(); };
      window.addEventListener('beforeprint', async ()=>{ updatePrintHeader(); try{ map.invalidateSize(); }catch(_){ } await ensureTilesReady(1500); });
      window.addEventListener('afterprint', ()=>{ setTimeout(()=>{ try{ map.invalidateSize(); }catch(_){ } }, 100); });

      // Recherche adresse
      async function geocodePhoton(q){ const url='https://photon.komoot.io/api/?q='+encodeURIComponent(q)+'&lang=fr&limit=5'; const r=await fetch(url); if(!r.ok) throw new Error('Photon'); const j=await r.json(); return (j.features||[]).map(f=>{ const g=f.geometry, p=f.properties||{}; if(!g||!g.coordinates) return null; const lat=g.coordinates[1], lng=g.coordinates[0]; const label=[p.housenumber,p.street,p.name,p.city,p.postcode].filter(Boolean).join(' '); return {label: label || p.name || q, lat, lng}; }).filter(Boolean); }
      async function geocodeNominatim(q){ const url='https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=5&q='+encodeURIComponent(q); const r=await fetch(url,{headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error('Nominatim'); const j=await r.json(); return j.map(o=>({label:o.display_name,lat:parseFloat(o.lat),lng:parseFloat(o.lon)})); }
      async function searchAddress(q){ const box=document.getElementById('searchResults'); box.textContent='Recherche‚Ä¶'; let res=[]; try{ res=await geocodePhoton(q); }catch(_){ } if(!res.length){ try{ res=await geocodeNominatim(q); }catch(_){ } }
        if(!res.length){ box.textContent='Aucun r√©sultat ou service indisponible.'; return; }
        const ul=document.createElement('ul'); res.forEach(r=>{ const li=document.createElement('li'); const a=document.createElement('a'); a.href='#'; a.textContent=r.label; a.dataset.lat=String(r.lat); a.dataset.lng=String(r.lng); a.dataset.label=r.label; li.appendChild(a); ul.appendChild(li); }); box.innerHTML=''; box.appendChild(ul);
      }
      document.getElementById('searchBtn').addEventListener('click', ()=>{ const q=(document.getElementById('searchQ').value||'').trim(); if(q) searchAddress(q); });
      document.getElementById('searchQ').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); const q=(e.target.value||'').trim(); if(q) searchAddress(q); } });
      document.getElementById('searchResults').addEventListener('click', e=>{ const a=e.target.closest('a[data-lat]'); if(!a) return; e.preventDefault(); addParticipant(parseFloat(a.dataset.lat), parseFloat(a.dataset.lng), selectedType(), a.dataset.label); map.setView([parseFloat(a.dataset.lat), parseFloat(a.dataset.lng)], 15); });

      // POI Is√®re (Overpass)
      async function loadPoiIsere(){
        const queries = [
`[out:json][timeout:60];
(
  rel["admin_level"="6"]["ref:INSEE"="38"];
  rel["admin_level"="6"]["name"="Is√®re"];
  rel["admin_level"="6"]["name"="Isere"];
); map_to_area->.a;
(
  node["amenity"="fire_station"](area.a);
  way["amenity"="fire_station"](area.a);
  relation["amenity"="fire_station"](area.a);
); out center tags;`,
`[out:json][timeout:60];
(
  node["amenity"="fire_station"](45.00,5.10,45.80,6.45);
  way["amenity"="fire_station"](45.00,5.10,45.80,6.45);
  relation["amenity"="fire_station"](45.00,5.10,45.80,6.45);
); out center tags;`
        ];
        const endpoints=['https://overpass-api.de/api/interpreter','https://overpass.kumi.systems/api/interpreter','https://lz4.overpass-api.de/api/interpreter'];
        const btn=document.getElementById('loadPoiIsere'); const prev=btn.textContent; btn.disabled=true; btn.textContent='Chargement‚Ä¶';

        function kindFromTags(tags){
          const t=(s)=>String(s||'').toUpperCase();
          const name=t(tags.name), op=t(tags.operator);
          if(/SDMIS/.test(name)||/SDMIS/.test(op)) return 'SDMIS';
          if(/STIS/.test(name)||/STIS/.test(op)) return 'STIS';
          if(/SLIS/.test(name)||/SLIS/.test(op)) return 'SLIS';
          if(/SDIS/.test(name)||/SDIS/.test(op)) return 'SDIS';
          return 'Caserne';
        }
        function parseAndAdd(j){
          const els=Array.isArray(j.elements)?j.elements:[]; let ok=0; const seen=new Set();
          for(const el of els){
            let lat=null,lng=null;
            if(el.type==='node'){ lat=el.lat; lng=el.lon; }
            else if(el.center){ lat=el.center.lat; lng=el.center.lon; }
            if(lat==null || lng==null) continue;
            const tags=el.tags||{}; const label=tags.name || tags['addr:place'] || tags['addr:city'] || 'Caserne';
            const key=`${(label||'').toLowerCase()}|${lat.toFixed(5)}|${lng.toFixed(5)}`;
            if(seen.has(key)) continue; seen.add(key);
            addPOI(lat,lng, kindFromTags(tags), label); ok++;
          }
          return ok;
        }

        let success=false;
        try{
          for(const q of queries){
            if(success) break;
            for(const ep of endpoints){
              try{
                const r=await fetch(ep+'?data='+encodeURIComponent(q),{headers:{'Accept':'application/json'}});
                if(!r.ok) throw new Error('HTTP '+r.status);
                const j=await r.json();
                const k=parseAndAdd(j);
                if(k>0){ success=true; break; }
              }catch(e){ /* essayer endpoint suivant */ }
            }
          }
          if(success){ tSet(statusEl, 'POI Is√®re charg√©s.'); }
          else{ tSet(statusEl, 'Aucun POI trouv√© (aire/bbox). V√©rifie le r√©seau.'); }
        }finally{
          btn.disabled=false; btn.textContent=prev;
        }
      }
      document.getElementById('loadPoiIsere').addEventListener('click', loadPoiIsere);
      document.getElementById('togglePoi').addEventListener('change', (e)=>{ if(e.target.checked){ poiLayer.addTo(map); } else { map.removeLayer(poiLayer); } });

      // DatARA WMS/WFS
      const ext = { wmsLayers: [], wfsLayers: [], visible: true };
      const extLayerGroup = L.layerGroup().addTo(map);
      function setExtStatus() { document.getElementById('extLayersCount').textContent = String(ext.wmsLayers.length + ext.wfsLayers.length); }
      function setStatus(txt){ try{ statusEl.className=''; statusEl.textContent=txt; }catch(_){} }

      async function fetchWmsLayers(capUrl) {
        const url = capUrl.replace(/\?.*$/, '') + '?service=WMS&request=GetCapabilities';
        const r = await fetch(url, { headers: { 'Accept': 'application/xml,text/xml' } });
        if (!r.ok) throw new Error('WMS GetCapabilities HTTP '+r.status);
        const xml = new DOMParser().parseFromString(await r.text(), 'application/xml');
        const layers = [...xml.querySelectorAll('Layer > Layer')].map(Ly => {
          const name = Ly.querySelector('Name')?.textContent || '';
          const title = Ly.querySelector('Title')?.textContent || name;
          return { name, title };
        }).filter(o => o.name);
        return layers;
      }
      document.getElementById('wmsListBtn').onclick = async () => {
        const base = (document.getElementById('wmsUrl').value || '').trim();
        const sel = document.getElementById('wmsLayerSel');
        sel.innerHTML = '<option>Chargement‚Ä¶</option>';
        try {
          const list = await fetchWmsLayers(base);
          if (!list.length) { sel.innerHTML = '<option>Aucune couche</option>'; return; }
          sel.innerHTML = '';
          list.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.name; opt.textContent = `${o.title}  [${o.name}]`;
            sel.appendChild(opt);
          });
          setStatus('Couches WMS list√©es.');
          localStorage.setItem('wms:lastUrl', base);
        } catch (e) {
          sel.innerHTML = '<option>Erreur de lecture</option>';
          setStatus('Erreur WMS : ' + e.message);
        }
      };
      document.getElementById('wmsAddBtn').onclick = () => {
        const base = (document.getElementById('wmsUrl').value || '').trim();
        const name = document.getElementById('wmsLayerSel').value;
        const opacity = parseFloat(document.getElementById('wmsOpacity').value || '0.8');
        if (!base || !name) return;
        const tile = L.tileLayer.wms(base, {
          layers: name, format: 'image/png', transparent: true, opacity,
          attribution: 'DatARA / DREAL AURA'
        }).addTo(extLayerGroup);
        ext.wmsLayers.push({ layer: name, name, tile });
        setExtStatus();
        localStorage.setItem('wms:lastLayer', name);
      };
      document.getElementById('wmsOpacity').addEventListener('input', (e) => {
        const op = parseFloat(e.target.value || '0.8');
        ext.wmsLayers.forEach(o => o.tile.setOpacity(op));
      });

      async function fetchWfsTypes(capUrl) {
        const url = capUrl.replace(/\?.*$/, '') + '?service=WFS&request=GetCapabilities';
        const r = await fetch(url, { headers: { 'Accept': 'application/xml,text/xml' } });
        if (!r.ok) throw new Error('WFS GetCapabilities HTTP '+r.status);
        const xml = new DOMParser().parseFromString(await r.text(), 'application/xml');
        const types = [...xml.querySelectorAll('FeatureTypeList FeatureType, WFS\\:FeatureTypeList WFS\\:FeatureType')].map(ft => {
          const n = ft.querySelector('Name, WFS\\:Name')?.textContent || '';
          const t = ft.querySelector('Title, WFS\\:Title')?.textContent || n;
          return { name: n, title: t };
        }).filter(o => o.name);
        return types;
      }
      document.getElementById('wfsListBtn').onclick = async () => {
        const base = (document.getElementById('wfsUrl').value || '').trim();
        const sel = document.getElementById('wfsTypeSel');
        sel.innerHTML = '<option>Chargement‚Ä¶</option>';
        try {
          const list = await fetchWfsTypes(base);
          if (!list.length) { sel.innerHTML = '<option>Aucun type</option>'; return; }
          sel.innerHTML = '';
          list.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.name; opt.textContent = `${o.title}  [${o.name}]`;
            sel.appendChild(opt);
          });
          setStatus('Types WFS list√©s.');
          localStorage.setItem('wfs:lastUrl', base);
        } catch (e) {
          sel.innerHTML = '<option>Erreur de lecture</option>';
          setStatus('Erreur WFS : ' + e.message);
        }
      };
      document.getElementById('wfsLoadBtn').onclick = async () => {
        const base = (document.getElementById('wfsUrl').value || '').trim();
        const typeName = document.getElementById('wfsTypeSel').value;
        const limit = parseInt(document.getElementById('wfsMaxFeat').value || '1000', 10);
        if (!base || !typeName) return;
        const b = map.getBounds();
        const bbox = [b.getWest(), b.getSouth(), b.getEast(), b.getNorth()].join(',');
        const url = base.replace(/\?.*$/, '') +
          `?service=WFS&version=1.1.0&request=GetFeature&typename=${encodeURIComponent(typeName)}` +
          `&outputFormat=application/json&srsName=EPSG:4326&BBOX=${bbox}&maxFeatures=${limit}`;
        try {
          setStatus('Chargement WFS‚Ä¶');
          const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!r.ok) throw new Error('HTTP '+r.status);
          const gj = await r.json();
          const geo = L.geoJSON(gj, {
            pointToLayer: (feat, latlng) => L.circleMarker(latlng, { radius: 5, color: '#111', weight: 2, fillOpacity: .4 }),
            style: { color: '#111', weight: 2, fillOpacity: .1 }
          }).addTo(extLayerGroup);
          ext.wfsLayers.push({ layer: typeName, name: typeName, geo });
          setExtStatus();
          setStatus('Couche WFS charg√©e.');
          localStorage.setItem('wfs:lastType', typeName);
        } catch (e) {
          setStatus('Erreur WFS : ' + e.message);
        }
      };
      document.getElementById('extToggleAll').onclick = (e) => { e.preventDefault(); ext.visible = !ext.visible; if (ext.visible) extLayerGroup.addTo(map); else map.removeLayer(extLayerGroup); };
      document.getElementById('extClearAll').onclick = (e) => { e.preventDefault(); extLayerGroup.clearLayers(); ext.wmsLayers = []; ext.wfsLayers = []; setExtStatus(); };
      (function restoreExtInputs(){ const wmsU = localStorage.getItem('wms:lastUrl'); if (wmsU) document.getElementById('wmsUrl').value = wmsU; const wfsU = localStorage.getItem('wfs:lastUrl'); if (wfsU) document.getElementById('wfsUrl').value = wfsU; })();

      // Producteur par d√©faut
      const DEFAULT_ADDR='210 Les Espinasses, 38250 Villard-de-Lans, France';
      const DEFAULT_FALLBACK={lat:45.073, lng:5.55};
      async function geocodeDefault(addr){
        try{ const r=await fetch('https://photon.komoot.io/api/?q='+encodeURIComponent(addr)+'&lang=fr&limit=1'); if(r.ok){ const j=await r.json(); const f=j.features?.[0]; if(f) return {lat:f.geometry.coordinates[1], lng:f.geometry.coordinates[0]}; } }catch(_){}
        try{ const r=await fetch('https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q='+encodeURIComponent(addr)); if(r.ok){ const j=await r.json(); const f=j[0]; if(f) return {lat:+f.lat, lng:+f.lon}; } }catch(_){}
        return null;
      }
      async function initDefaultProducer(){
        try{ const saved=localStorage.getItem('defaultProducer');
          if(saved){ const o=JSON.parse(saved); if(o && o.lat && o.lng){ addParticipant(o.lat,o.lng,'producer', o.name||'Producteur'); if(!document.getElementById('projName').value) document.getElementById('projName').value='Projet 1'; tSet(statusEl,'Producteur par d√©faut charg√©.'); return; }
        }}catch(_){ }
        const g=await geocodeDefault(DEFAULT_ADDR);
        if(g){ addParticipant(g.lat,g.lng,'producer','Producteur ‚Äî d√©faut'); try{ localStorage.setItem('defaultProducer', JSON.stringify({lat:g.lat,lng:g.lng,name:'Producteur ‚Äî d√©faut'})); }catch(_){ } tSet(statusEl,'Producteur par d√©faut g√©ocod√©.'); }
        else { addParticipant(DEFAULT_FALLBACK.lat, DEFAULT_FALLBACK.lng,'producer','Producteur ‚Äî approx.'); tSet(statusEl,'Producteur par d√©faut approx.'); }
      }
      document.getElementById('resetDefaultBtn').addEventListener('click', ()=>{ try{ localStorage.removeItem('defaultProducer'); tSet(statusEl,'Producteur par d√©faut r√©initialis√©.'); }catch(_){ } });

      // Import participants
      document.getElementById('importBtn').onclick = ()=>{
        const txt=(document.getElementById('bulk').value||'').trim(); if(!txt) return;
        let ok=0,ko=0; txt.split(/\r?\n/).forEach(line=>{
          if(!line.trim()) return; const p=line.split(/[;,]|\t/).map(s=>s.trim());
          if(p.length<4){ko++;return;} const [name,latS,lonS,typeS]=p;
          const lat=+latS, lng=+lonS; if(!isFinite(lat)||!isFinite(lng)){ko++;return;}
          let t=(typeS||'').toLowerCase(); if(t.startsWith('cons')) t='consumer'; else if(t.startsWith('prod')) t='producer'; else {ko++;return;}
          addParticipant(lat,lng,t,name); ok++;
        });
        tSet(statusEl,`Import participants : ${ok} ajout√©(s), ${ko} rejet√©(s).`);
      };

      // Chronologie ACC
      const TL_LS_KEY = 'acc_timeline_v1';
      const defaultTimeline = [
        {title:'Cadrage & objectifs', tip:'Objectifs √©co/sociaux/territoriaux', due:'', done:false},
        {title:'Recrutement consommateurs', tip:'D√©marrer ~6 mois avant lancement', due:'', done:false},
        {title:'√âtude faisabilit√© centrale', tip:'PV/hydro/√©olien, conformit√©', due:'', done:false},
        {title:'√âtude ACC (√©nergie/√©co/financier)', tip:'Sc√©narios, TURPE, cl√©s de r√©partition', due:'', done:false},
        {title:'Cr√©ation/identification PMO', tip:'Association/SAS‚Ä¶ obligations PMO', due:'', done:false},
        {title:'Adh√©sions des participants √† la PMO', tip:'Statuts, bulletins', due:'', done:false},
        {title:'D√©claration + Convention ACC (Enedis)', tip:'Signature ‚â•1 mois apr√®s raccordement', due:'', done:false},
        {title:'Contrats producteurs‚Üîconsommateurs', tip:'Gr√© √† gr√© (particuliers ‚â§1 an)', due:'', done:false},
        {title:'D√©marrage op√©ration', tip:'1er du mois suivant la signature', due:'', done:false},
        {title:'Exploitation & reporting', tip:'Donn√©es mensuelles GRD / PMO', due:'', done:false}
      ];
      function loadTL(){ try{ return JSON.parse(localStorage.getItem(TL_LS_KEY)) || defaultTimeline.slice(); }catch(_){ return defaultTimeline.slice(); } }
      function saveTL(items){ try{ localStorage.setItem(TL_LS_KEY, JSON.stringify(items)); }catch(_){ } }
      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&gt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
      function renderTL(){
        const root = document.getElementById('accTimeline');
        const items = loadTL();
        const today = new Date().toISOString().slice(0,10);
        const tbl = document.createElement('table'); tbl.className='tl-table';
        tbl.innerHTML = `
          <thead><tr>
            <th style="width:28px">‚úì</th>
            <th>√âtape</th>
            <th>Note</th>
            <th style="width:150px">√âch√©ance</th>
            <th style="width:110px">Actions</th>
          </tr></thead>
          <tbody></tbody>`;
        const tb = tbl.querySelector('tbody');
        items.forEach((it, idx)=>{
          const overdue = it.due && !it.done && it.due < today;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" ${it.done?'checked':''} data-idx="${idx}"></td>
            <td>${escapeHtml(it.title)}</td>
            <td>${escapeHtml(it.tip||'')}</td>
            <td>
              <input type="date" value="${it.due||''}" data-idx="${idx}" class="tl-date" style="width:140px">
              ${overdue?'<div class="tl-overdue">En retard</div>': (it.done?'<div class="tl-done">Termin√©</div>':'')}
            </td>
            <td>
              <button class="btn secondary tl-up" data-idx="${idx}" title="Monter">‚Üë</button>
              <button class="btn secondary tl-down" data-idx="${idx}" title="Descendre">‚Üì</button>
              <button class="btn secondary tl-del" data-idx="${idx}" title="Supprimer">‚úï</button>
            </td>`;
          tb.appendChild(tr);
        });
        root.innerHTML = ''; root.appendChild(tbl);

        root.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
          cb.addEventListener('change', e=>{
            const i = +e.target.dataset.idx; const arr = loadTL(); arr[i].done = e.target.checked; saveTL(arr); renderTL();
          });
        });
        root.querySelectorAll('.tl-date').forEach(inp=>{
          inp.addEventListener('change', e=>{
            const i = +e.target.dataset.idx; const arr = loadTL(); arr[i].due = e.target.value; saveTL(arr); renderTL();
          });
        });
        root.querySelectorAll('.tl-up').forEach(b=> b.onclick = () => { const i=+b.dataset.idx; const arr=loadTL(); if(i>0){ [arr[i-1],arr[i]]=[arr[i],arr[i-1]]; saveTL(arr); renderTL(); }});
        root.querySelectorAll('.tl-down').forEach(b=> b.onclick = () => { const i=+b.dataset.idx; const arr=loadTL(); if(i<arr.length-1){ [arr[i+1],arr[i]]=[arr[i],arr[i+1]]; saveTL(arr); renderTL(); }});
        root.querySelectorAll('.tl-del').forEach(b=> b.onclick = () => { const i=+b.dataset.idx; const arr=loadTL(); arr.splice(i,1); saveTL(arr); renderTL(); });
      }
      document.getElementById('tlAddStep').onclick = ()=>{
        const title = prompt('Intitul√© de la nouvelle √©tape :'); if(!title) return;
        const tip = prompt('Note (optionnel) :') || '';
        const due = prompt('√âch√©ance (YYYY-MM-DD, optionnel) :') || '';
        const arr = loadTL(); arr.push({title, tip, due, done:false}); saveTL(arr); renderTL();
      };
      document.getElementById('tlClear').onclick = ()=>{
        if(confirm('R√©initialiser la chronologie aux valeurs par d√©faut ?')){ saveTL(defaultTimeline.slice()); renderTL(); }
      };
      document.getElementById('tlExportCsv').onclick = ()=>{
        const arr = loadTL();
        const csv = [
          'title;note;due;done',
          ...arr.map(it=>[
            `"${String(it.title).replace(/"/g,'""')}"`,
            `"${String(it.tip||'').replace(/"/g,'""')}"`,
            it.due||'',
            it.done?'1':'0'
          ].join(';'))
        ].join('\n');
        const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'chronologie_acc.csv'; a.click();
        URL.revokeObjectURL(url);
      };
      renderTL();

      // Lancer
      try{ initDefaultProducer(); }catch(_){ }
      layout();
      tSet(statusEl,'Pr√™t.');
      window.addEventListener('error', e=>{ tSet(statusEl,'Erreur JS : '+e.message); });
      window.addEventListener('unhandledrejection', e=>{ tSet(statusEl,'Erreur Promesse : '+(e.reason?.message||e.reason)); });
    }
  </script>
</body>
</html>
