<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACC ‚Äì Zone et p√©rim√®tre</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <meta name="theme-color" content="#37C3AF">

  <style>
    :root{--ink:#1c1c1c;--line:#e6eaea;--muted:#f7f8f8;--ok:#0f766e;--bad:#b91c1c;--brand:#37C3AF}
    html,body{height:100%}
    body{margin:0;font-family:'Open Sans', system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;color:var(--ink);background:#fff}
    header.slim{display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--line);padding:6px 8px}
    .brand{display:flex;align-items:center;gap:8px}
    .brand svg{height:26px;width:auto;border-radius:6px;box-shadow:0 0 0 1px rgba(0,0,0,.06)}
    .brand .name{font-family:'Montserrat',sans-serif;font-weight:700;letter-spacing:.3px}
    .controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:space-between;width:100%}
    .group{display:flex;align-items:center;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .dot{width:10px;height:10px;border-radius:50%}
    .prod{background:#6D28D9}.cons{background:#2e86de}.poi{background:#E10600}
    .btn{padding:6px 8px;border:1px solid var(--brand);border-radius:10px;background:var(--brand);color:#fff;cursor:pointer;font-weight:700}
    .btn.icon{padding:6px 8px;min-width:36px;display:inline-flex;align-items:center;justify-content:center}
    .btn.secondary{background:#fff;color:#0f4f47;border-color:var(--brand)}
    select,input[type="number"],input[type="text"]{border:1px solid var(--line);border-radius:8px;padding:6px 8px}
    #status{margin:6px 8px 0;border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff;font-size:14px}
    #status.ok{background:rgba(55,195,175,.08);border-color:rgba(55,195,175,.45);color:#116a60}
    #status.ko{background:#fff5f3;border-color:#f6d2cc}
    #map{min-height:420px;margin:8px;border:1px solid var(--line);border-radius:12px;position:relative}
    .legend-overlay{position:absolute;bottom:10px;left:10px;background:rgba(255,255,255,.9);border:1px solid var(--line);border-radius:8px;padding:6px 8px;display:flex;gap:10px;align-items:center;font-size:12px}
    .legend-overlay .item{display:flex;align-items:center;gap:6px}
    .leaflet-control.ratio-control{background:rgba(255,255,255,.95);border:1px solid var(--line);border-radius:8px;padding:4px 8px;font-size:12px;z-index:1000}
  </style>
</head>
<body>
  <!-- BARRE -->
  <header class="slim">
    <div class="brand" role="img" aria-label="Echome √ânergies">
      <svg viewBox="0 0 120 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="0" y="0" width="120" height="32" rx="6" fill="#37C3AF"/>
        <text x="60" y="19" text-anchor="middle" font-family="Montserrat, Arial, sans-serif" font-size="14" fill="#ffffff">ECHOME</text>
      </svg>
      <span class="name">Echome √ânergies</span>
    </div>
    <div class="controls">
      <div class="group" role="radiogroup" aria-label="Type de point (ACC)">
        <label class="chip"><input type="radio" name="ptype" value="consumer" checked> <span class="dot cons"></span>Cons.</label>
        <label class="chip"><input type="radio" name="ptype" value="producer"> <span class="dot prod"></span>Prod.</label>
      </div>
      <div class="group" aria-label="Diam√®tre">
        <label class="small">Diam√®tre :</label>
        <select id="limitSel">
          <option value="2">2 km</option>
          <option value="10">10 km</option>
          <option value="20" selected>20 km</option>
          <option value="custom">Perso</option>
        </select>
        <input id="customKm" type="number" min="0" step="0.1" placeholder="km" style="width:90px;display:none">
      </div>
      <div class="group">
        <button id="locateBtn" class="btn icon" title="Me localiser">üìç</button>
        <button id="fitBtn" class="btn icon" title="Ajuster la vue">üó∫Ô∏è</button>
        <button id="printBtn" class="btn icon" title="Exporter en PDF">üñ®Ô∏è</button>
        <button id="clearBtn" class="btn icon" title="Effacer les points">üóëÔ∏è</button>
      </div>
    </div>
  </header>

  <div id="status">Initialisation‚Ä¶</div>
  <div id="map" aria-label="Carte interactive">
    <div class="legend-overlay">
      <div class="item"><span class="dot prod"></span>Producteur</div>
      <div class="item"><span class="dot cons"></span>Consommateur</div>
      <div class="item"><span class="dot poi"></span>POI incendie</div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
    function initApp(){
      const map = L.map('map').setView([45.3,5.6], 8);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);
      L.control.scale({imperial:false, metric:true, maxWidth:120}).addTo(map);

      // √âchelle 1:n
      const RatioControl = L.Control.extend({
        options: { position: 'topright' },
        onAdd: function(map){
          const div = L.DomUtil.create('div','leaflet-control ratio-control');
          this._div = div; this._map = map;
          const update = ()=>{
            const c=this._map.getCenter(), z=this._map.getZoom();
            if(z==null){ this._div.textContent='√âchelle ‚Äî'; return; }
            const mpp = 156543.03392 * Math.cos(c.lat*Math.PI/180) / Math.pow(2, z);
            const denom = Math.max(1, Math.round(mpp / 0.0002645833333));
            this._div.textContent = '√âchelle ~ 1:' + denom.toLocaleString('fr-FR');
          };
          map.on('zoomend moveend', update); update(); return div;
        }
      });
      map.addControl(new RatioControl());
    }
    initApp();
  </script>
</body>
</html>
