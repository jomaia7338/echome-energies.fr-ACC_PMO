<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACC ‚Äì V√©rification d‚Äô√©ligibilit√© (centre libre ¬∑ 2/10/20 km)</title>
  <!-- Leaflet minimal -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    :root{--ink:#1c1c1c;--line:#e6eaea;--muted:#f7f8f8;--ok:#0f766e;--bad:#b91c1c;--brand:#37C3AF}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:#fff}
    header{padding:12px;border-bottom:1px solid var(--line)}
    header h1{margin:0 0 6px 0;font-size:18px}
    .toolbar{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:8px}
    .tool{background:var(--muted);border:1px solid var(--line);border-radius:10px;padding:10px}
    .tool label{font-size:12px;color:#475569;display:block;margin-bottom:6px}
    .tool .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .btn{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;font-weight:600}
    .btn:hover{border-color:#cfd8d8}
    #status{margin:10px 12px 0;border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff;font-size:14px}
    #status.ok{background:#f2fbf7;border-color:#c7eadf}
    #status.ko{background:#fff5f3;border-color:#f6d2cc}
    #map{height:calc(100svh - 210px);min-height:420px;margin:12px;border:1px solid var(--line);border-radius:12px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}
    .prod{background:#e74c3c}.cons{background:#2e86de}.sdis{background:#f1c40f}
    .small{font-size:12px;color:#64748b}
    @media (max-width: 1100px){ .toolbar{grid-template-columns:1fr 1fr} #map{height:calc(100svh - 320px)} }
    @media (max-width: 640px){ .toolbar{grid-template-columns:1fr} #map{height:calc(100svh - 440px)} }
  </style>
</head>
<body>
  <header>
    <h1>ACC ‚Äì V√©rification d‚Äô√©ligibilit√© (centre libre)</h1>
    <div class="toolbar">
      <div class="tool">
        <label>1) Ajouter des points (clic carte) ‚Äî choisir le type :</label>
        <div class="row">
          <label><input type="radio" name="ptype" value="consumer" checked> <span class="dot cons"></span>Consommateur</label>
          <label><input type="radio" name="ptype" value="producer"> <span class="dot prod"></span>Producteur</label>
          <label><input type="radio" name="ptype" value="sdis"> <span class="dot sdis"></span>SDIS</label>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="clearBtn" class="btn">Effacer tous les points</button>
          <button id="fitBtn" class="btn">Ajuster la vue</button>
          <button id="locateBtn" class="btn">üìç Me localiser</button>
        </div>
        <div id="count" class="small" style="margin-top:6px">Aucun point.</div>
      </div>

      <div class="tool">
        <label>2) Limite r√©glementaire (R)</label>
        <div class="row">
          <label><input type="radio" name="limit" value="2"> 2 km</label>
          <label><input type="radio" name="limit" value="10"> 10 km</label>
          <label><input type="radio" name="limit" value="20" checked> 20 km</label>
        </div>
        <div class="row" style="margin-top:6px">
          <label><input type="radio" name="limit" value="custom"> Perso :</label>
          <input id="customKm" type="number" min="0" step="0.1" style="width:110px" placeholder="km">
        </div>
        <div class="row" style="margin-top:6px">
          <label><input id="includeSdis" type="checkbox"> Inclure SDIS (option)</label>
        </div>
      </div>

      <div class="tool">
        <label>3) Import rapide (Nom;Lat;Lon;Type)</label>
        <textarea id="bulk" placeholder="Usine A;45.76;4.84;producer\nColl√®ge B;45.77;4.86;consumer" style="width:100%;min-height:80px"></textarea>
        <div class="row" style="margin-top:6px"><button id="importBtn" class="btn">Importer</button></div>
        <div class="small">Types accept√©s¬†: consumer / producer / sdis</div>
      </div>

      <div class="tool">
        <label>4) Export</label>
        <div class="row"><button id="exportCsvBtn" class="btn">Exporter CSV</button></div>
        <div class="small" style="margin-top:6px">CSV s√©parateur ¬´¬†;¬†¬ª (Excel FR), lat/lon en WGS84</div>
      </div>
    </div>
  </header>

  <div id="status">But p√©dagogique¬†: <strong>existe-t‚Äëil un centre libre</strong> tel qu‚Äôun <strong>cercle de rayon R</strong> contienne le producteur et tous les abonn√©s √©ligibles¬†? (SDIS exclu par d√©faut)</div>
  <div id="map" aria-label="Carte interactive"></div>

  <script>
    // ‚Äî‚Äî‚Äî Helpers
    const eps = 1e-9;
    function toRad(d){ return d*Math.PI/180; }
    function haversineKm(a,b){
      const R=6371; const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng);
      const lat1=toRad(a.lat), lat2=toRad(b.lat);
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }
    function splitLines(t){ return (t||'').split(/\r?\n/); }

    // Proj. locale (km) & MEC (paires+triplets, robuste)
    function projectLocal(pointsLL){
      const lat0 = pointsLL.reduce((s,p)=>s+p.lat,0)/pointsLL.length;
      const lon0 = pointsLL.reduce((s,p)=>s+p.lng,0)/pointsLL.length;
      const P = pointsLL.map(p=>({ x:(p.lng-lon0)*111.32*Math.cos(lat0*Math.PI/180), y:(p.lat-lat0)*111.32, ref:p }));
      return {lat0, lon0, P};
    }
    function unprojectLocal(lat0, lon0, x, y){ return {lat:lat0 + y/111.32, lng: lon0 + x/(111.32*Math.cos(lat0*Math.PI/180))}; }
    function dist2(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return dx*dx+dy*dy; }
    function circleBy2(a,b){ return {x:(a.x+b.x)/2, y:(a.y+b.y)/2, r:Math.sqrt(dist2(a,b))/2}; }
    function circleBy3(a,b,c){
      const A=b.x-a.x, B=b.y-a.y, C=c.x-a.x, D=c.y-a.y;
      const E=A*(a.x+b.x)+B*(a.y+b.y); const F=C*(a.x+c.x)+D*(a.y+c.y);
      const G=2*(A*(c.y-b.y)-B*(c.x-b.x)); if(Math.abs(G)<1e-12) return null; // colin√©aires
      const x=(D*E-B*F)/G, y=(A*F-C*E)/G; const r=Math.hypot(x-a.x,y-a.y); return {x,y,r};
    }
    function inCircle(c,p){ return Math.hypot(c.x-p.x,c.y-p.y) <= c.r + 1e-9; }
    function minimalEnclosingCircle(pointsLL){
      if(pointsLL.length===0) return null; if(pointsLL.length===1) return {center:pointsLL[0], r:0};
      const {lat0, lon0, P} = projectLocal(pointsLL);
      let best=null;
      for(let i=0;i<P.length;i++) for(let j=i+1;j<P.length;j++){ const c=circleBy2(P[i],P[j]); if(P.every(p=>inCircle(c,p))) if(!best||c.r<best.r) best=c; }
      for(let i=0;i<P.length;i++) for(let j=i+1;j<P.length;j++) for(let k=j+1;k<P.length;k++){ const c=circleBy3(P[i],P[j],P[k]); if(!c) continue; if(P.every(p=>inCircle(c,p))) if(!best||c.r<best.r) best=c; }
      if(!best){ let max=-1,a=-1,b=-1; for(let i=0;i<P.length;i++) for(let j=i+1;j<P.length;j++){ const d=dist2(P[i],P[j]); if(d>max){max=d;a=i;b=j;} } best=circleBy2(P[a],P[b]); }
      const center = unprojectLocal(lat0, lon0, best.x, best.y);
      return {center, r:best.r}; // r en km (approx locale)
    }

    // ‚Äî‚Äî‚Äî Carte
    const map = L.map('map', { zoomControl: true }).setView([46.6, 2.0], 6);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' }).addTo(map);
    L.control.scale({imperial:false, metric:true, maxWidth:120}).addTo(map);
    setTimeout(()=>{ try{ map.invalidateSize();

    // ‚Äî‚Äî‚Äî G√©olocalisation utilisateur (optionnelle)
    let myMarker=null, myAccCircle=null;
    function clearMyLoc(){ if(myMarker){map.removeLayer(myMarker); myMarker=null;} if(myAccCircle){map.removeLayer(myAccCircle); myAccCircle=null;} }
    function locateMe(){
      if(!navigator.geolocation){ const s=document.getElementById('status'); s.className=''; s.textContent='G√©olocalisation non support√©e par ce navigateur.'; return; }
      map.locate({setView:true, maxZoom:15, enableHighAccuracy:true});
    }
    map.on('locationfound', e=>{
      clearMyLoc();
      myMarker=L.circleMarker(e.latlng,{radius:7,color:'#111827',weight:2,fillColor:'#111827',fillOpacity:0.4}).addTo(map).bindTooltip('Vous √™tes ici');
      myAccCircle=L.circle(e.latlng,{radius:e.accuracy||50,color:'#111827',weight:1,opacity:0.4,fillOpacity:0.05}).addTo(map);
      const s=document.getElementById('status'); s.className=''; s.textContent=`Localis√© (~¬±${Math.round(e.accuracy||50)} m).`;
    });
    map.on('locationerror', e=>{ const s=document.getElementById('status'); s.className=''; s.textContent='G√©olocalisation indisponible (autorisation refus√©e ?).'; }); }catch(_){} }, 100);

    // ‚Äî‚Äî‚Äî √âtat
    const participants=[]; // {id,name,type,lat,lng,marker}
    let uid=0; let accCircle=null; let accCenterMarker=null;
    const colors={producer:'#e74c3c', consumer:'#2e86de', sdis:'#f1c40f'};

    function selectedType(){ return document.querySelector('input[name="ptype"]:checked').value; }
    function includeSdis(){ return document.getElementById('includeSdis').checked; }
    function currentLimit(){ const sel=document.querySelector('input[name="limit"]:checked').value; if(sel==='custom'){ const v=parseFloat(document.getElementById('customKm').value||'0'); return (isNaN(v)||v<=0)?20:v; } return parseFloat(sel); }

    function updateCount(){ const c=document.getElementById('count'); const n=participants.length; const np=participants.filter(p=>p.type==='producer').length; c.textContent = n? `${n} point${n>1?'s':''} dont ${np} producteur${np>1?'s':''}.` : 'Aucun point.'; }

    function addPoint(lat,lng,type,name){
      const id=++uid; const label=name||`${type} ${id}`;
      const m=L.circleMarker([lat,lng],{radius:7,color:colors[type]||'#333',weight:2,fillColor:colors[type]||'#333',fillOpacity:0.3}).addTo(map);
      m.bindTooltip(`${label} (${type})`);
      m.bindPopup(`
        <strong>${label}</strong><br>${type}<br>
        <div class="row" style="margin-top:6px">
          <button class="btn" data-act="rename" data-id="${id}">Renommer</button>
          <button class="btn" data-act="delete" data-id="${id}">Supprimer</button>
        </div>
      `);
      m.on('popupopen', e=>{
        const root=e.popup.getElement();
        const ren=root.querySelector('button[data-act="rename"][data-id="'+id+'"]');
        const del=root.querySelector('button[data-act="delete"][data-id="'+id+'"]');
        if(ren) ren.addEventListener('click', ()=>{
          const entry=participants.find(p=>p.id===id); if(!entry) return;
          const nn=prompt('Nouveau nom :', entry.name||'');
          if(nn && nn.trim()){
            entry.name=nn.trim();
            m.setPopupContent(`
              <strong>${entry.name}</strong><br>${entry.type}<br>
              <div class=\"row\" style=\"margin-top:6px\">
                <button class=\"btn\" data-act=\"rename\" data-id=\"${id}\">Renommer</button>
                <button class=\"btn\" data-act=\"delete\" data-id=\"${id}\">Supprimer</button>
              </div>
            `);
            m.bindTooltip(`${entry.name} (${entry.type})`);
          }
        });
        if(del) del.addEventListener('click', ()=> removePoint(id));
      });
      m.on('contextmenu', ()=> removePoint(id));
      participants.push({id,name:label,type,lat,lng,marker:m});
      refreshACC();
    }
    function removePoint(id){ const i=participants.findIndex(p=>p.id===id); if(i>-1){ map.removeLayer(participants[i].marker); participants.splice(i,1); refreshACC(); } }
    map.on('click', e=>{ addPoint(e.latlng.lat, e.latlng.lng, selectedType()); });

    function clearAccCircle(){ if(accCircle){map.removeLayer(accCircle); accCircle=null;} if(accCenterMarker){map.removeLayer(accCenterMarker); accCenterMarker=null;} }

    function styleInsideOutside(center, limitKm, eligible){
      eligible.forEach(p=>{
        const d = haversineKm(center, {lat:p.lat,lng:p.lng});
        const inside = d <= limitKm + eps;
        p.marker.setStyle({ color: inside? '#15803d' : '#b91c1c', weight: inside? 2:2, fillColor: colors[p.type]||'#333', fillOpacity: inside? 0.35:0.15 });
      });
    }

    function refreshACC(){
      updateCount();
      const limit = currentLimit();
      const status = document.getElementById('status');
      const eligibles = participants.filter(p=> includeSdis()? true : p.type!=='sdis');
      const hasProducer = eligibles.some(p=> p.type==='producer');
      clearAccCircle();

      if(!eligibles.length){ status.className=''; status.textContent='Ajoutez un producteur et des consommateurs (SDIS exclu par d√©faut).'; return; }
      if(!hasProducer){ status.className=''; status.textContent='Aucun producteur d√©tect√© : ajoutez au moins un point ¬´¬†Producteur¬†¬ª.'; return; }

      const mec = minimalEnclosingCircle(eligibles.map(p=>({lat:p.lat,lng:p.lng})));
      // Affiche le cercle d'√©tude de rayon = limite (R), centr√© sur le centre libre MEC
      accCircle = L.circle([mec.center.lat, mec.center.lng], {radius: limit*1000, color: '#111827', weight:2, fill:false, opacity:0.85}).addTo(map);
      accCenterMarker = L.circleMarker([mec.center.lat, mec.center.lng], {radius:5, color:'#111827', weight:2, fillOpacity:0.6}).addTo(map);

      const pass = mec.r <= limit + eps;
      styleInsideOutside(mec.center, limit, eligibles);

      if(pass){
        status.className='ok';
        status.innerHTML = `<strong>Conforme</strong> ‚Äî Il existe un <strong>centre libre</strong> tel qu‚Äôun <strong>cercle de rayon ${limit} km</strong> contienne le producteur et tous les abonn√©s √©ligibles.<br><span class="small">Centre sugg√©r√©¬†: ${mec.center.lat.toFixed(5)}, ${mec.center.lng.toFixed(5)} ¬∑ Rayon minimal requis¬†: ${mec.r.toFixed(2)} km (‚â§ ${limit} km)</span>`;
      } else {
        // Lister les points hors zone R autour du centre optimal (informatif)
        const outside = eligibles.filter(p=> haversineKm(mec.center,{lat:p.lat,lng:p.lng}) > limit + eps).map(p=> p.name||p.type);
        status.className='ko';
        status.innerHTML = `<strong>Non conforme</strong> ‚Äî Aucun centre libre ne peut englober tous les participants dans un cercle de <strong>${limit} km</strong>.<br><span class="small">Rayon minimal requis¬†: ${mec.r.toFixed(2)} km (> ${limit} km). Points limitants¬†: ${outside.join(', ')||'‚Äî'}</span>`;
      }
    }

    // ‚Äî‚Äî‚Äî UI
    document.getElementById('clearBtn').onclick = ()=>{ participants.slice().forEach(p=> removePoint(p.id)); };
    document.getElementById('fitBtn').onclick = ()=>{ if(!participants.length) return; const g=L.featureGroup(participants.map(p=>p.marker)); map.fitBounds(g.getBounds().pad(0.25)); };
    Array.from(document.getElementsByName('limit')).forEach(r=> r.addEventListener('change', refreshACC));
    document.getElementById('customKm').addEventListener('input', ()=>{ if(document.querySelector('input[name="limit"][value="custom"]').checked) refreshACC(); });
    document.getElementById('includeSdis').addEventListener('change', refreshACC);
    const locateBtn=document.getElementById('locateBtn'); if(locateBtn) locateBtn.addEventListener('click', locateMe);

    document.getElementById('importBtn').onclick = ()=>{
      const txt=(document.getElementById('bulk').value||'').trim(); if(!txt) return;
      let ok=0,ko=0; splitLines(txt).forEach(line=>{
        if(!line.trim()) return; const p=line.split(/[;,]|\t/).map(s=>s.trim());
        if(p.length<4){ko++;return;} const [name, latS, lonS, typeS] = p; const lat=parseFloat(latS), lng=parseFloat(lonS);
        if(isNaN(lat)||isNaN(lng)){ko++;return;} let t=(typeS||'').toLowerCase(); if(t.startsWith('cons')) t='consumer'; else if(t.startsWith('prod')) t='producer'; else if(t!=='sdis'){ko++;return;}
        addPoint(lat,lng,t,name); ok++;
      });
      const box=document.getElementById('status'); box.className=''; box.innerHTML = `Import¬†: ${ok} ajout√©(s), ${ko} rejet√©(s).`;
    };

    document.getElementById('exportCsvBtn').onclick = ()=>{
      if(!participants.length) return;
      const header='name;lat;lon;type';
      const rows=participants.map(p=>[p.name?.replace(/;/g,','), p.lat.toFixed(6), p.lng.toFixed(6), p.type].join(';'));
      const csv=[header,...rows].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='acc_points.csv'; a.click(); URL.revokeObjectURL(url);
    };

    // ‚Äî‚Äî‚Äî D√©part : rien par d√©faut (tu ajoutes tes points)
  </script>
</body>
</html>
