<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Echome Énergies — ACC/PMO (Débug)</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg: #0b1020;
      --panel: #11162a;
      --muted: #c6c9d1;
      --brand: #39b77a;
      --danger: #cc2b4a;
      --border: #20263d;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: #e8eaf0;
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    header {
      position: sticky; top: 0; z-index: 1000;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: .6rem .8rem;
      display: flex; gap: .75rem; align-items: center; flex-wrap: wrap;
    }
    header h1 { font-size: 14px; margin: 0; letter-spacing: .2px; color: #fff; }
    #status { margin-left: auto; color: var(--muted); }
    main { display: grid; grid-template-columns: 360px 1fr; gap: 10px; padding: 10px; }
    @media (max-width: 900px){ main { grid-template-columns: 1fr; } }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: .9rem;
    }
    .grid { display: grid; gap: .75rem; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: .25rem; }
    input, select, button {
      background: #0f1426; color: #e8eaf0;
      border: 1px solid var(--border); border-radius: 10px;
      padding: .55rem .65rem; font: inherit;
    }
    input:focus, select:focus, button:focus { outline: 1px solid #2a3866; }
    button.primary { background: #103024; border-color: #1b4f3a; }
    button.primary:hover { background: #124533; }
    button.ghost { background: transparent; }
    button.danger { background: #3a1020; border-color: #5b1830; }
    button.danger:hover { background: #52152d; }
    .muted { color: var(--muted); }
    #map { min-height: 70vh; border-radius: 12px; overflow: hidden; }
    #error-box {
      border: 1px solid #5b2431; background: #2a0e17; color: #ffd7df;
      border-radius: 10px; padding: .6rem .75rem; white-space: pre-wrap; display: none;
    }
    .kpis { display: grid; grid-template-columns: repeat(3,1fr); gap: .5rem; }
    .kpi { background: #0f1426; border: 1px solid var(--border); border-radius: 10px; padding: .6rem; }
    .kpi b { font-size: 18px; display: block; margin-top: .2rem; }
    .sep { height: 1px; background: var(--border); margin: .6rem 0; }
    .small { font-size: 12px; }
    .pill { display: inline-block; font-size: 11px; border: 1px solid var(--border); border-radius: 999px; padding: .15rem .5rem; color: var(--muted); }
    .legend { display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; }
    .chip { display: inline-flex; gap: .4rem; align-items: center; background:#0f1426; border:1px solid var(--border); border-radius:999px; padding:.25rem .55rem; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .dot.prod { background:#f5b841; }
    .dot.cons { background:#4ea2ff; }
    .dot.sis { background:#ff6b7a; }
  </style>
</head>
<body>
  <header>
    <h1>ACC/PMO — Débug</h1>
    <span id="status" class="muted">Initialisation…</span>
  </header>

  <main>
    <section class="card grid" id="leftPanel">
      <div id="error-box"></div>

      <div class="kpis">
        <div class="kpi">
          <span class="muted small">Participants</span>
          <b id="kpiParticipants">0</b>
        </div>
        <div class="kpi">
          <span class="muted small">Dans D/2</span>
          <b id="kpiDansD2">0</b>
        </div>
        <div class="kpi">
          <span class="muted small">POI (SIS)</span>
          <b id="kpiSIS">0</b>
        </div>
      </div>

      <div class="legend">
        <span class="chip"><span class="dot prod"></span> Producteur</span>
        <span class="chip"><span class="dot cons"></span> Consommateur</span>
        <span class="chip"><span class="dot sis"></span> SIS</span>
        <span class="pill" id="communePill">Commune: —</span>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div>
          <label>Latitude centre</label>
          <input id="lat" type="number" step="0.000001" placeholder="45.191000" />
        </div>
        <div>
          <label>Longitude centre</label>
          <input id="lon" type="number" step="0.000001" placeholder="5.684000" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Diamètre (km)</label>
          <select id="diam">
            <option value="2">2</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="perso">Perso…</option>
          </select>
        </div>
        <div>
          <label>Diamètre perso (km)</label>
          <input id="diamPerso" type="number" step="0.1" placeholder="Saisir si Perso" />
        </div>
      </div>

      <div class="row">
        <button id="btnRecentrer">Recentrer carte</button>
        <button id="btnSIS" class="ghost">Charger POI SIS</button>
      </div>

      <div class="sep"></div>

      <div class="grid">
        <div class="row">
          <div>
            <label>Importer participants (CSV ; Nom;Lat;Lon;consumer|producer)</label>
            <input id="fileCsv" type="file" accept=".csv,text/csv" />
          </div>
          <div style="display:flex;align-items:end;gap:.5rem;">
            <button id="btnImportCsv">Importer</button>
            <button id="btnExportCsv" class="ghost">Exporter</button>
          </div>
        </div>
        <div class="row">
          <button id="btnSaveLocal" class="primary">Enregistrer (local)</button>
          <div style="display:flex;gap:.5rem;">
            <button id="btnLoadLocal">Charger</button>
            <button id="btnDeleteLocal" class="danger">Supprimer</button>
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div>
        <span class="muted small">Astuce :</span>
        <div class="small muted">
          - Clique sur la carte pour déplacer le centre<br/>
          - Le cercle représente <b>D/2</b> (rayon), les marqueurs colorés les participants, et les POI SIS en rose.<br/>
          - L’onglet Console affiche les détails techniques (F12).
        </div>
      </div>
    </section>

    <section class="card">
      <div id="map"></div>
    </section>
  </main>

  <script>
    /* ---------- Utilitaires ---------- */
    function setStatus(msg){ document.getElementById('status').textContent = msg; }
    function showError(msg){
      const box = document.getElementById('error-box');
      box.style.display = 'block';
      box.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      console.error(msg);
    }
    async function fetchJSON(url, { method='GET', body, headers={}, timeoutMs=15000, retries=1, expect='auto' } = {}){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, { method, body, headers, signal: ctrl.signal, cache:'no-store' });
        if(!res.ok){
          const txt = await res.text().catch(()=> '');
          throw new Error(`HTTP ${res.status} on ${url} :: ${txt.slice(0,240)}`);
        }
        const ct = res.headers.get('content-type')||'';
        if(expect==='text') return await res.text();
        if(expect==='json' || ct.includes('application/json')) return await res.json();
        const raw = await res.text(); try{ return JSON.parse(raw); }catch{ return raw; }
      }catch(e){
        if(retries>0){ await new Promise(r=>setTimeout(r, Math.min(2500, timeoutMs/3))); return fetchJSON(url,{method,body,headers,timeoutMs:Math.round(timeoutMs*1.5),retries:retries-1,expect}); }
        throw e;
      }finally{ clearTimeout(t); }
    }
    const OVERPASS_URL = 'https://overpass-api.de/api/interpreter';
    async function overpass(query){
      try{
        const body = new URLSearchParams({ data: query }).toString();
        return await fetchJSON(OVERPASS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body, timeoutMs: 20000, retries: 2, expect: 'json'
        });
      }catch(e){ showError(`Overpass KO: ${e.message}`); return null; }
    }
    async function getCommuneParCoord(lat, lon){
      const url = `https://geo.api.gouv.fr/communes?lat=${lat}&lon=${lon}&fields=nom,code,epci&format=json&type=commune`;
      try{
        const arr = await fetchJSON(url, { timeoutMs: 10000, retries: 1, expect:'json' });
        if(!Array.isArray(arr)||arr.length===0) throw new Error('Aucune commune trouvée');
        return arr[0];
      }catch(e){ showError(`Commune/EPCI KO: ${e.message}`); return null; }
    }
    function haversineMeters(a,b){
      const R=6371000, toRad=d=>d*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const lat1=toRad(a.lat), lat2=toRad(b.lat);
      const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }
    function pointDansD2(centre, point, diamKm){ const r=(diamKm*1000)/2; return haversineMeters(centre, point) <= r+1; }
    function parseParticipantsCSV(text){
      const rows=text.trim().split(/\r?\n/), out=[], errors=[];
      rows.forEach((line,i)=>{
        if(!line.trim()) return;
        const [nom, lat, lon, typeRaw] = line.split(';').map(s=>s?.trim());
        const type=(typeRaw||'').toLowerCase();
        if(!nom||!lat||!lon||!['consumer','producer'].includes(type)){ errors.push(`L${i+1}: "${line}"`); return; }
        const la=Number(lat), lo=Number(lon);
        if(!Number.isFinite(la)||!Number.isFinite(lo)){ errors.push(`L${i+1}: coords invalides`); return; }
        out.push({ id: crypto.randomUUID(), nom, lat: la, lon: lo, type });
      });
      return { out, errors };
    }
    const STORAGE_KEY='echome-acc-project-v1';
    function saveProject(state){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({__v:1, savedAt:new Date().toISOString(), state})); setStatus('Projet enregistré (local)'); }catch(e){ showError(`Sauvegarde KO: ${e.message}`); } }
    function loadProject(){ try{ const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):null; }catch(e){ showError('Projet corrompu'); return null; } }
    function deleteProject(){ localStorage.removeItem(STORAGE_KEY); setStatus('Projet supprimé (local)'); }

    /* ---------- État applicatif minimal ---------- */
    const app = {
      map: null,
      centerMarker: null,
      circle: null,
      layers: { participants: L.layerGroup(), sis: L.layerGroup() },
      participants: [],
      centre: { lat: 45.191, lon: 5.684 }, // Valeur par défaut: Grenoble (à adapter si besoin)
      diamKm: 5
    };

    /* ---------- Carte ---------- */
    function setupMap(){
      app.map = L.map('map', { zoomControl: true }).setView([app.centre.lat, app.centre.lon], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OSM'
      }).addTo(app.map);
      app.layers.participants.addTo(app.map);
      app.layers.sis.addTo(app.map);

      app.centerMarker = L.marker([app.centre.lat, app.centre.lon], { draggable: true }).addTo(app.map);
      app.centerMarker.on('dragend', () => {
        const { lat, lng } = app.centerMarker.getLatLng();
        app.centre = { lat, lon: lng };
        document.getElementById('lat').value = lat.toFixed(6);
        document.getElementById('lon').value = lng.toFixed(6);
        redrawCircle();
        refreshComputed();
      });

      app.map.on('click', (e) => {
        app.centre = { lat: e.latlng.lat, lon: e.latlng.lng };
        app.centerMarker.setLatLng([app.centre.lat, app.centre.lon]);
        document.getElementById('lat').value = app.centre.lat.toFixed(6);
        document.getElementById('lon').value = app.centre.lon.toFixed(6);
        redrawCircle();
        refreshComputed();
      });

      redrawCircle();
    }
    function redrawCircle(){
      const radius = Math.max(1, (app.diamKm * 1000) / 2);
      if(app.circle) app.map.removeLayer(app.circle);
      app.circle = L.circle([app.centre.lat, app.centre.lon], { radius, color:'#39b77a', weight:1, fillOpacity:0.08 }).addTo(app.map);
    }

    /* ---------- Participants ---------- */
    function drawParticipants(){
      app.layers.participants.clearLayers();
      app.participants.forEach(p=>{
        const color = p.type === 'producer' ? '#f5b841' : '#4ea2ff';
        L.circleMarker([p.lat, p.lon], { radius: 6, color, weight: 2, fillOpacity: .7 })
          .bindPopup(`<b>${p.nom}</b><br>${p.type}<br>${p.lat.toFixed(5)}, ${p.lon.toFixed(5)}`)
          .addTo(app.layers.participants);
      });
      document.getElementById('kpiParticipants').textContent = app.participants.length;
    }

    /* ---------- SIS (Overpass) ---------- */
    function overpassSISQuery({ lat, lon, diamKm }){
      const r = Math.max(1, Math.round((diamKm*1000)/2));
      return `
        [out:json][timeout:25];
        (
          node(around:${r},${lat},${lon})["emergency"="fire_hydrant"];
          node(around:${r},${lat},${lon})["amenity"="fire_station"];
          way(around:${r},${lat},${lon})["amenity"="fire_station"];
          relation(around:${r},${lat},${lon})["amenity"="fire_station"];
        );
        out center;
      `;
    }
    async function loadSIS(){
      setStatus('Chargement SIS…');
      const q = overpassSISQuery({ lat: app.centre.lat, lon: app.centre.lon, diamKm: app.diamKm });
      const data = await overpass(q);
      app.layers.sis.clearLayers();
      let cnt = 0;
      if(data && Array.isArray(data.elements)){
        data.elements.forEach(e=>{
          const lat = e.lat ?? e.center?.lat;
          const lon = e.lon ?? e.center?.lon;
          if(Number.isFinite(lat) && Number.isFinite(lon)){
            cnt++;
            L.circleMarker([lat, lon], { radius: 6, color:'#ff6b7a', weight:2, fillOpacity:.7 })
              .bindPopup(`<b>SIS</b><br>${lat.toFixed(5)}, ${lon.toFixed(5)}`)
              .addTo(app.layers.sis);
          }
        });
      }
      document.getElementById('kpiSIS').textContent = cnt;
      setStatus('Prêt');
    }

    /* ---------- Calcul & KPI ---------- */
    function refreshComputed(){
      // Commune/EPCI
      getCommuneParCoord(app.centre.lat, app.centre.lon).then(c=>{
        const pill = document.getElementById('communePill');
        if(c){ pill.textContent = `Commune: ${c.nom}${c.epci?.nom ? ' — EPCI: '+c.epci.nom : ''}`; }
      });

      // Dans D/2
      const d2 = app.participants.filter(p=> pointDansD2(app.centre, {lat:p.lat, lon:p.lon}, app.diamKm)).length;
      document.getElementById('kpiDansD2').textContent = d2;
    }

    /* ---------- Export CSV ---------- */
    function exportCSV(){
      const rows = [['Nom','Lat','Lon','Type'], ...app.participants.map(p=>[p.nom,p.lat,p.lon,p.type])];
      const csv = rows.map(r=>r.join(';')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `participants_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    /* ---------- Wiring UI ---------- */
    function wireUI(){
      const $ = id => document.getElementById(id);

      // Champs centre
      $('lat').value = app.centre.lat.toFixed(6);
      $('lon').value = app.centre.lon.toFixed(6);
      $('lat').addEventListener('change', e => { app.centre.lat = Number(e.target.value)||app.centre.lat; app.centerMarker.setLatLng([app.centre.lat, app.centre.lon]); redrawCircle(); refreshComputed(); });
      $('lon').addEventListener('change', e => { app.centre.lon = Number(e.target.value)||app.centre.lon; app.centerMarker.setLatLng([app.centre.lat, app.centre.lon]); redrawCircle(); refreshComputed(); });

      // Diamètre
      function readDiam(){
        const v = $('diam').value;
        if(v==='perso'){
          const d = Number($('diamPerso').value);
          app.diamKm = Number.isFinite(d) && d>0 ? d : app.diamKm;
        } else {
          app.diamKm = Number(v);
        }
        redrawCircle(); refreshComputed();
      }
      $('diam').addEventListener('change', readDiam);
      $('diamPerso').addEventListener('change', readDiam);

      // Actions
      $('btnRecentrer').onclick = ()=>{ app.map.setView([app.centre.lat, app.centre.lon], 13); };
      $('btnSIS').onclick = loadSIS;

      $('btnImportCsv').onclick = async ()=>{
        const file = $('fileCsv').files?.[0];
        if(!file) return showError('Aucun fichier CSV sélectionné');
        const text = await file.text();
        const { out, errors } = parseParticipantsCSV(text);
        if(errors.length){ showError(`${errors.length} erreur(s) d’import:\n- ${errors.join('\n- ')}`); }
        app.participants = out;
        drawParticipants(); refreshComputed();
      };
      $('btnExportCsv').onclick = exportCSV;

      $('btnSaveLocal').onclick = ()=>{
        const state = {
          centre: app.centre,
          diamKm: app.diamKm,
          participants: app.participants
        };
        saveProject(state);
      };
      $('btnLoadLocal').onclick = ()=>{
        const payload = loadProject();
        if(!payload) return showError('Aucun projet sauvegardé');
        const s = payload.state || {};
        if(s.centre) app.centre = s.centre;
        if(s.diamKm) app.diamKm = s.diamKm;
        if(s.participants) app.participants = s.participants;
        $('lat').value = app.centre.lat.toFixed(6);
        $('lon').value = app.centre.lon.toFixed(6);
        $('diam').value = [2,5,10,15,20].includes(Number(app.diamKm)) ? String(app.diamKm) : 'perso';
        if($('diam').value==='perso') $('diamPerso').value = app.diamKm;
        app.centerMarker.setLatLng([app.centre.lat, app.centre.lon]);
        redrawCircle(); drawParticipants(); refreshComputed();
        setStatus('Projet chargé (local)');
      };
      $('btnDeleteLocal').onclick = ()=>{ deleteProject(); };
    }

    /* ---------- Bootstrap ---------- */
    (async function init(){
      try{
        setStatus('Initialisation…');
        setupMap();
        wireUI();
        drawParticipants();
        refreshComputed();
        setStatus('Prêt');
      }catch(e){
        showError(`Init KO: ${e.message}`);
        setStatus('Erreur (voir détails)');
      }
    })();
  </script>
</body>
</html>
